# Coding Standards & Guidelines

> **Auto-generated by NSO init.** Customize for your project.

## 1. General Principles

- **Clarity over cleverness:** Code should be easy for both humans and LLMs to understand.
- **Validation first:** No code is written without a corresponding validation step (test, compile check, or lint).
- **Single responsibility:** Functions and classes should be small, single-purpose, and testable.
- **Fail fast:** Public functions must begin with assertions on their inputs.

## 2. Style Guide

<!-- NSO will populate the relevant section based on project type detection. -->
<!-- Delete sections that don't apply to your project. -->

### TypeScript / JavaScript

- **Strict mode:** `strict: true` in `tsconfig.json`.
- **Functional:** Prefer functional patterns (`map`/`filter`/`reduce`) over imperative loops.
- **Immutability:** Use `const` everywhere possible. Avoid mutation.
- **Async:** Always handle rejected promises. Never fire-and-forget.
- **Naming:** `camelCase` for variables/functions, `PascalCase` for components/classes/types, `SCREAMING_SNAKE` for constants.
- **Imports:** Group by: (1) external packages, (2) internal modules, (3) relative imports. Blank line between groups.

### Python

- **Typing:** Strict type hints (`mypy` strict mode recommended).
- **Docstrings:** Google-style docstrings for all public methods.
- **Error handling:** Use custom exceptions; avoid bare `try/except`.
- **Dependencies:** Managed via `uv`, `poetry`, or `pip` with pinned versions.

### CSS / Styling

- **Tokens:** Use CSS variables or design tokens — never hardcode hex values.
- **Utility-first:** Prefer Tailwind utility classes over custom CSS where available.
- **Responsive:** Mobile-first. Use container queries for component-level responsiveness.

## 3. Observability (NSO Requirement)

Any code performing external I/O (Fetch, DB, API, File) MUST include explicit start/success/failure logging:

```typescript
console.log(`[${new Date().toISOString()}] FETCH_START: ${url}`);
try {
  const result = await fetch(url);
  console.log(`[${new Date().toISOString()}] FETCH_SUCCESS: ${url} (${result.status})`);
  return result;
} catch (error) {
  console.error(`[${new Date().toISOString()}] FETCH_FAIL: ${url}`, error);
  throw error;
}
```

## 4. Testing Standards

- **TDD cycle:** Write failing test → implement → verify → refactor.
- **Naming:** Test names describe behavior: `it("returns empty array when no items match filter")`.
- **Coverage:** All public APIs must have tests. Internal helpers tested through their public consumers.
- **Isolation:** Tests must not depend on external services or global state.

## 5. Documentation

- **In-code:** JSDoc/docstrings for all public APIs.
- **Architecture decisions:** Significant changes get an ADR (Architectural Decision Record) in `docs/architecture/`.
- **Context updates:** Changes to tech stack or patterns must be reflected in `.opencode/context/`.

## 6. Git Conventions

- **Commits:** Concise, descriptive messages. Focus on "why" not "what".
- **Branches:** Feature branches via worktree for BUILD workflow.
- **No secrets:** Never commit API keys, tokens, or credentials.
- **E2E tests before push (REQUIRED):** Any change that touches real functionality — Hub routes, MCP tools, browser extensions, ArtifactStore, PatchEngine, or any production code path — MUST have the full E2E suite run and passing before `git push`. Run: `yarn test:e2e`. Unit tests alone are not sufficient for functional changes. If E2E tests fail, the push is blocked until fixed.

---

## 7. CRITICAL PROJECT RESTRICTIONS

> These rules are enforced by Janitor in every validation pass. Violations are BLOCKERS.

### 7.1 Never Modify opencode Server Code

**Rule:** The opencode server (`/Users/Shared/dev/opencode/`) is **read-only**. Never modify, patch, or fork any file in the opencode repository.

**Rationale:**
- We connect to opencode as an **external process**
- The only integration point is the native `instructions` URL support
- This ensures easy upgrades to future opencode versions

**How to comply:**
- All integrations happen via REST API, SSE, or the `instructions` URL mechanism
- If you need a feature from opencode, implement it in our extensions, not by modifying opencode
- The opencode directory should show as unmodified in git

### 7.2 Never Modify Theia Core Code

**Rule:** The Theia framework code in `node_modules/@theia/` is **read-only**. Never modify, patch, or monkey-patch any file in Theia's packages.

**Rationale:**
- Theia Openspace extends Theia via its **extension API** (ContainerModule, CommandContribution, FilterContribution, etc.)
- This ensures easy upgrades to future Theia versions
- Patching Theia creates a fork that diverges from upstream

**How to comply:**
- Use proper Theia extension patterns:
  - `ContainerModule` for DI bindings
  - `CommandContribution` for commands
  - `FilterContribution` for filtering UI
  - `FrontendApplicationContribution` for lifecycle hooks
  - `ReactWidget` for custom UI
  - `WidgetOpenHandler` for file type handlers
- Never use `Object.prototype` extension, monkey-patching, or direct module modification
- If Theia doesn't provide an extension point, propose it upstream first

### 7.3 Validation

Every Janitor validation pass will check:
- No modified files in `/Users/Shared/dev/opencode/`
- No modified files in `node_modules/@theia/`
- All custom code uses proper extension APIs

**This is not optional. Violations are immediate blockers.**
