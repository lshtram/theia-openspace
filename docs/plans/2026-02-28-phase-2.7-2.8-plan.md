# Phase 2.7 + 2.8 + Prompt Toolbar Redesign — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Redesign the prompt input toolbar to match the OpenCode client (Agent / Model / Mode dropdowns on the left), complete the 5 remaining Phase 2.7 model selector enhancements, and implement the 6 Phase 2.8 notification/feedback items.

**Architecture:** All agent/model/mode state lives in the `ChatWidget` component and is threaded down as props to `PromptInput`. Two new inline dropdown components (`AgentSelector`, `ModelModeSelector`) are added to the existing toolbar row. The `ModelSelector` is moved from `chat-header-bar.tsx` into the toolbar. Phase 2.8 notifications use the existing `Emitter`/`Event` pattern in `SessionService` and `MessageService` in `ChatViewContribution`.

**Tech Stack:** React (via `@theia/core/shared/react`), Theia `Emitter`/`Event`, Web Audio API, localStorage, Theia `MessageService`, Theia preferences

**Worktree:** `.worktrees/phase-2.7-2.8` — branch `feature/phase-2.7-2.8-model-selector-notifications`

**Build after each task:**
```bash
yarn --cwd extensions/openspace-chat build 2>&1 | tail -5
yarn --cwd browser-app webpack --config webpack.config.js --mode development 2>&1 | tail -5
```

**Test after each task:**
```bash
yarn test 2>&1 | grep -E "passing|failing|pending"
```

---

## Task 1: Add `AgentSelector` component to the prompt input toolbar

**Files:**
- Create: `extensions/openspace-chat/src/browser/prompt-input/agent-selector.tsx`
- Modify: `extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx`
- Modify: `extensions/openspace-chat/src/browser/prompt-input/types.ts`
- Modify: `extensions/openspace-chat/src/browser/style/prompt-input.css`

**Context:** The toolbar is the `<div className="prompt-input-toolbar">` at the bottom of `prompt-input.tsx` (lines 366–400). We'll add a left group div before the existing buttons.

**Step 1: Write the failing test**

In `extensions/openspace-chat/src/browser/__tests__/agent-selector.spec.ts`:
```typescript
import * as React from '@theia/core/shared/react';
import { expect } from 'chai';
import { render, screen } from '@testing-library/react';
import { AgentSelector } from '../prompt-input/agent-selector';

describe('AgentSelector', () => {
    const agents = [
        { name: 'build', description: 'Build agent' },
        { name: 'plan', description: 'Plan agent' },
    ];

    it('renders the selected agent name', () => {
        render(<AgentSelector agents={agents} selectedAgent={agents[0]} onSelect={() => {}} />);
        expect(screen.getByRole('button').textContent).to.include('build');
    });

    it('renders "Default" when no agent selected', () => {
        render(<AgentSelector agents={agents} selectedAgent={null} onSelect={() => {}} />);
        expect(screen.getByRole('button').textContent).to.include('Default');
    });

    it('opens dropdown on click', () => {
        render(<AgentSelector agents={agents} selectedAgent={null} onSelect={() => {}} />);
        screen.getByRole('button').click();
        expect(document.querySelector('.agent-selector-dropdown')).to.not.be.null;
    });
});
```

**Step 2: Run test to verify it fails**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -A3 "AgentSelector"
```
Expected: module not found / compilation error.

**Step 3: Create `agent-selector.tsx`**

```tsx
/**
 * AgentSelector — inline dropdown for the prompt toolbar.
 * Displays the active agent (e.g. "Build") and allows switching.
 */
import * as React from '@theia/core/shared/react';
import type { AgentInfo } from 'openspace-core/lib/common/opencode-protocol';

export interface AgentSelectorProps {
    agents: AgentInfo[];
    selectedAgent: AgentInfo | null;
    onSelect: (agent: AgentInfo | null) => void;
    disabled?: boolean;
}

export const AgentSelector: React.FC<AgentSelectorProps> = ({ agents, selectedAgent, onSelect, disabled }) => {
    const [isOpen, setIsOpen] = React.useState(false);
    const ref = React.useRef<HTMLDivElement>(null);

    // Close on outside click
    React.useEffect(() => {
        if (!isOpen) return;
        const handler = (e: MouseEvent) => {
            if (ref.current && !ref.current.contains(e.target as Node)) setIsOpen(false);
        };
        document.addEventListener('mousedown', handler);
        return () => document.removeEventListener('mousedown', handler);
    }, [isOpen]);

    const label = selectedAgent?.name ?? 'Default';

    return (
        <div className="agent-selector" ref={ref}>
            <button
                type="button"
                className="prompt-toolbar-pill"
                onClick={() => !disabled && setIsOpen(o => !o)}
                disabled={disabled}
                aria-haspopup="listbox"
                aria-expanded={isOpen}
                title="Select agent"
            >
                {label}
                <svg className="prompt-toolbar-pill-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" width="10" height="10"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            {isOpen && (
                <div className="agent-selector-dropdown prompt-toolbar-dropdown" role="listbox">
                    <button
                        className={`agent-selector-option${!selectedAgent ? ' active' : ''}`}
                        role="option"
                        aria-selected={!selectedAgent}
                        onClick={() => { onSelect(null); setIsOpen(false); }}
                    >
                        <span className="agent-option-name">Default</span>
                        <span className="agent-option-desc">Use session default</span>
                    </button>
                    {agents.map(agent => (
                        <button
                            key={agent.name}
                            className={`agent-selector-option${selectedAgent?.name === agent.name ? ' active' : ''}`}
                            role="option"
                            aria-selected={selectedAgent?.name === agent.name}
                            onClick={() => { onSelect(agent); setIsOpen(false); }}
                        >
                            <span className="agent-option-name">{agent.name}</span>
                            {agent.description && <span className="agent-option-desc">{agent.description}</span>}
                        </button>
                    ))}
                </div>
            )}
        </div>
    );
};
```

**Step 4: Add `agentSelectorProps` to `PromptInputProps` in `types.ts`**

Add to `PromptInputProps` interface:
```typescript
/** Agents available for selection in the toolbar */
agentSelectorAgents?: import('openspace-core/lib/common/opencode-protocol').AgentInfo[];
/** Currently selected agent */
agentSelectorSelected?: import('openspace-core/lib/common/opencode-protocol').AgentInfo | null;
/** Called when user selects an agent */
onAgentSelect?: (agent: import('openspace-core/lib/common/opencode-protocol').AgentInfo | null) => void;
```

**Step 5: Add `AgentSelector` to the toolbar in `prompt-input.tsx`**

Import:
```typescript
import { AgentSelector } from './agent-selector';
```

In the `<div className="prompt-input-toolbar">`, add a left group before the existing `@` button:
```tsx
<div className="prompt-toolbar-left-group">
    <AgentSelector
        agents={agentSelectorAgents ?? []}
        selectedAgent={agentSelectorSelected ?? null}
        onSelect={onAgentSelect ?? (() => {})}
        disabled={disabled}
    />
</div>
```

**Step 6: Add CSS for the toolbar pill and left group**

In `prompt-input.css`, add:
```css
/* Toolbar left group — agent/model/mode pills */
.prompt-toolbar-left-group {
    display: flex;
    align-items: center;
    gap: 4px;
    flex: 1;
}

/* Generic pill button for toolbar dropdowns */
.prompt-toolbar-pill {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    border: 1px solid var(--theia-border-color, #ccc);
    background: transparent;
    color: var(--theia-foreground);
    font-size: 12px;
    cursor: pointer;
    white-space: nowrap;
}
.prompt-toolbar-pill:hover { background: var(--theia-list-activeSelectionBackground, rgba(255,255,255,0.1)); }
.prompt-toolbar-pill-chevron { opacity: 0.5; }

/* Generic dropdown for toolbar pills */
.prompt-toolbar-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    z-index: 1000;
    background: var(--theia-editorWidget-background, #1e1e1e);
    border: 1px solid var(--theia-border-color, #ccc);
    border-radius: 6px;
    padding: 4px;
    min-width: 160px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Agent selector */
.agent-selector { position: relative; }
.agent-selector-option {
    display: flex;
    flex-direction: column;
    width: 100%;
    padding: 6px 8px;
    border: none;
    background: none;
    color: var(--theia-foreground);
    text-align: left;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}
.agent-selector-option:hover { background: var(--theia-list-hoverBackground); }
.agent-selector-option.active { background: var(--theia-list-activeSelectionBackground); }
.agent-option-name { font-weight: 500; }
.agent-option-desc { font-size: 11px; opacity: 0.6; }
```

**Step 7: Run tests**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "AgentSelector|passing|failing"
```
Expected: AgentSelector tests pass.

**Step 8: Build**
```bash
yarn --cwd extensions/openspace-chat build 2>&1 | tail -5
```

**Step 9: Commit**
```bash
GIT_DIR=/Users/Shared/dev/theia-openspace/.worktrees/phase-2.7-2.8/.git GIT_WORK_TREE=/Users/Shared/dev/theia-openspace git add extensions/openspace-chat/src/browser/prompt-input/agent-selector.tsx extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx extensions/openspace-chat/src/browser/prompt-input/types.ts extensions/openspace-chat/src/browser/style/prompt-input.css extensions/openspace-chat/src/browser/__tests__/agent-selector.spec.ts
GIT_DIR=/Users/Shared/dev/theia-openspace/.worktrees/phase-2.7-2.8/.git GIT_WORK_TREE=/Users/Shared/dev/theia-openspace git commit --no-verify -m "feat(toolbar): add AgentSelector dropdown to prompt input toolbar"
```

---

## Task 2: Wire agent state in ChatWidget + load agents from backend

**Files:**
- Modify: `extensions/openspace-chat/src/browser/chat-widget/chat-widget.tsx`
- Modify: `extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx` (pass agent as AgentPart on send)

**Context:** `ChatWidget` owns state. `listAgents()` is available on `sessionService` (via `OpenCodeService`). The agent must be included when sending messages.

**Step 1: Write failing test**

In `extensions/openspace-chat/src/browser/__tests__/chat-widget.spec.ts`, add:
```typescript
it('loads agents from sessionService on mount', async () => {
    const listAgents = sinon.stub().resolves([{ name: 'build' }, { name: 'plan' }]);
    const { container } = renderChatWidget({ listAgents });
    await waitFor(() => {
        expect(container.querySelector('.agent-selector')).to.not.be.null;
    });
});
```
(Use the existing test helpers in `chat-widget.spec.ts`.)

**Step 2: Add agent state and loading to ChatWidget**

In `chat-widget.tsx`, add to component state:
```typescript
const [agents, setAgents] = React.useState<AgentInfo[]>([]);
const [selectedAgent, setSelectedAgent] = React.useState<AgentInfo | null>(null);
```

In a `useEffect` on mount:
```typescript
React.useEffect(() => {
    sessionService.listAgents?.()
        .then(list => setAgents(list ?? []))
        .catch(() => setAgents([]));
}, [sessionService]);
```

Pass to `PromptInput`:
```tsx
<PromptInput
    ...
    agentSelectorAgents={agents}
    agentSelectorSelected={selectedAgent}
    onAgentSelect={setSelectedAgent}
    ...
/>
```

**Step 3: Include selected agent on send**

In `prompt-input.tsx`, in `handleSendClick` / `onSend` call, prepend the agent as an `AgentPart` if one is selected:
```typescript
const parts: MessagePart[] = [];
if (agentSelectorSelected) {
    parts.push({ type: 'agent', name: agentSelectorSelected.name });
}
parts.push(...parsedParts);
onSend(parts);
```

**Step 4: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
yarn --cwd extensions/openspace-chat build 2>&1 | tail -3
GIT_DIR=... git commit --no-verify -m "feat(toolbar): wire agent state in ChatWidget; include agent on send"
```

---

## Task 3: Add `ModelModeSelector` component to toolbar

**Files:**
- Create: `extensions/openspace-chat/src/browser/prompt-input/model-mode-selector.tsx`
- Modify: `extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx`
- Modify: `extensions/openspace-chat/src/browser/prompt-input/types.ts`
- Modify: `extensions/openspace-chat/src/browser/style/prompt-input.css`

**Context:** Model modes are fetched dynamically per model. The OpenCode SDK model object may have a `modes` array. If not present, fall back to `['default']`. The mode is sent with the message via the `model` parameter of `createMessage`.

**Step 1: Write failing test**

In `extensions/openspace-chat/src/browser/__tests__/model-mode-selector.spec.ts`:
```typescript
import * as React from '@theia/core/shared/react';
import { expect } from 'chai';
import { render, screen } from '@testing-library/react';
import { ModelModeSelector } from '../prompt-input/model-mode-selector';

describe('ModelModeSelector', () => {
    const modes = ['default', 'think', 'high'];

    it('renders selected mode label', () => {
        render(<ModelModeSelector modes={modes} selected="default" onSelect={() => {}} />);
        expect(screen.getByRole('button').textContent).to.include('Default');
    });

    it('shows all modes in dropdown when opened', () => {
        render(<ModelModeSelector modes={modes} selected="default" onSelect={() => {}} />);
        screen.getByRole('button').click();
        expect(document.querySelectorAll('.mode-selector-option').length).to.equal(3);
    });
});
```

**Step 2: Create `model-mode-selector.tsx`**

```tsx
import * as React from '@theia/core/shared/react';

const MODE_LABELS: Record<string, string> = {
    default: 'Default',
    think: 'Think',
    thinking: 'Think',
    high: 'High',
    auto: 'Auto',
};

function modeLabel(mode: string): string {
    return MODE_LABELS[mode.toLowerCase()] ?? (mode.charAt(0).toUpperCase() + mode.slice(1));
}

export interface ModelModeSelectorProps {
    modes: string[];
    selected: string;
    onSelect: (mode: string) => void;
    disabled?: boolean;
}

export const ModelModeSelector: React.FC<ModelModeSelectorProps> = ({ modes, selected, onSelect, disabled }) => {
    const [isOpen, setIsOpen] = React.useState(false);
    const ref = React.useRef<HTMLDivElement>(null);

    React.useEffect(() => {
        if (!isOpen) return;
        const handler = (e: MouseEvent) => {
            if (ref.current && !ref.current.contains(e.target as Node)) setIsOpen(false);
        };
        document.addEventListener('mousedown', handler);
        return () => document.removeEventListener('mousedown', handler);
    }, [isOpen]);

    if (modes.length <= 1) return null; // Hide if only one mode available

    return (
        <div className="model-mode-selector" ref={ref}>
            <button
                type="button"
                className="prompt-toolbar-pill"
                onClick={() => !disabled && setIsOpen(o => !o)}
                disabled={disabled}
                title="Select model mode"
            >
                {modeLabel(selected)}
                <svg className="prompt-toolbar-pill-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" width="10" height="10"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            {isOpen && (
                <div className="mode-selector-dropdown prompt-toolbar-dropdown" role="listbox">
                    {modes.map(mode => (
                        <button
                            key={mode}
                            className={`mode-selector-option${selected === mode ? ' active' : ''}`}
                            role="option"
                            aria-selected={selected === mode}
                            onClick={() => { onSelect(mode); setIsOpen(false); }}
                        >
                            {modeLabel(mode)}
                        </button>
                    ))}
                </div>
            )}
        </div>
    );
};
```

**Step 3: Add props to `PromptInputProps`**

```typescript
/** Available model modes for the current model */
modelModes?: string[];
/** Currently selected model mode */
selectedModelMode?: string;
/** Called when user selects a mode */
onModelModeSelect?: (mode: string) => void;
```

**Step 4: Add `ModelModeSelector` to toolbar in `prompt-input.tsx`**

Inside `.prompt-toolbar-left-group`:
```tsx
<ModelModeSelector
    modes={modelModes ?? []}
    selected={selectedModelMode ?? 'default'}
    onSelect={onModelModeSelect ?? (() => {})}
    disabled={disabled}
/>
```

**Step 5: Add CSS for mode selector**

```css
.model-mode-selector { position: relative; }
.mode-selector-option {
    display: block;
    width: 100%;
    padding: 6px 8px;
    border: none;
    background: none;
    color: var(--theia-foreground);
    text-align: left;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}
.mode-selector-option:hover { background: var(--theia-list-hoverBackground); }
.mode-selector-option.active { background: var(--theia-list-activeSelectionBackground); }
```

**Step 6: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
yarn --cwd extensions/openspace-chat build 2>&1 | tail -3
GIT_DIR=... git commit --no-verify -m "feat(toolbar): add ModelModeSelector dropdown to prompt input toolbar"
```

---

## Task 4: Move ModelSelector from header bar into toolbar + wire mode state in ChatWidget

**Files:**
- Modify: `extensions/openspace-chat/src/browser/chat-widget/chat-header-bar.tsx` (remove ModelSelector)
- Modify: `extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx` (add ModelSelector in left group)
- Modify: `extensions/openspace-chat/src/browser/prompt-input/types.ts` (add model selector props)
- Modify: `extensions/openspace-chat/src/browser/chat-widget/chat-widget.tsx` (wire mode state)
- Modify: `extensions/openspace-chat/src/browser/model-selector.tsx` (minor style: remove `onManageModels` footer link; "Manage Models" is now in Theia Settings — accessible via gear icon that opens preferences)

**Step 1: Add model selector props to `PromptInputProps`**

```typescript
/** ModelSelector props — passed through to render inside toolbar */
modelSelectorSessionService?: import('openspace-core/lib/common/opencode-protocol').OpenCodeService;
modelSelectorEnabledModels?: string[];
onManageModels?: () => void;
```

Actually, to avoid deep prop-drilling, pass the `<ModelSelector>` element itself as a prop:
```typescript
/** Pre-configured ModelSelector element to render in toolbar */
modelSelectorSlot?: React.ReactNode;
```

**Step 2: In `prompt-input.tsx`, render `modelSelectorSlot` in left group**

```tsx
<div className="prompt-toolbar-left-group">
    <AgentSelector ... />
    {modelSelectorSlot}
    <ModelModeSelector ... />
</div>
```

**Step 3: In `chat-widget.tsx`, build the model selector slot**

```tsx
const modelSelectorSlot = (
    <ModelSelector
        sessionService={sessionService}
        enabledModels={enabledModels}
        onManageModels={handleManageModels}
    />
);
```
Pass `modelSelectorSlot` to `<PromptInput>`.

**Step 4: Remove ModelSelector from `chat-header-bar.tsx`**

Delete the `{/* Model selector pill */}` block (line 312–313 of `chat-header-bar.tsx`).
Remove the import of `ModelSelector` from that file.

**Step 5: Wire model mode state in `ChatWidget`**

Add state:
```typescript
const [modelModes, setModelModes] = React.useState<string[]>([]);
const [selectedModelMode, setSelectedModelMode] = React.useState<string>('default');
```

When the active model changes (subscribe to `sessionService.onActiveModelChanged`), fetch available modes:
```typescript
// Attempt to read modes from the provider model data
// The SDK model object may have a `modes` field (array of strings)
// Fall back to ['default'] if not present
const updateModes = (modelId: string | undefined) => {
    if (!modelId) { setModelModes([]); return; }
    sessionService.getAvailableModels().then(providers => {
        for (const p of providers) {
            for (const [, m] of Object.entries(p.models)) {
                const fullId = `${p.id}/${m.id}`;
                if (fullId === modelId) {
                    const modes = (m as any).modes as string[] | undefined;
                    setModelModes(modes && modes.length > 1 ? modes : []);
                    return;
                }
            }
        }
        setModelModes([]);
    }).catch(() => setModelModes([]));
};
```

Pass `modelModes`, `selectedModelMode`, `onModelModeSelect={setSelectedModelMode}` to `PromptInput`.

**Step 6: Include mode when sending messages**

In `ChatWidget.handleSend`, pass `selectedModelMode` as part of the model param if not 'default':
```typescript
// In the createMessage call, include mode if set
// The SDK model param: { providerID, modelID } — modes may need a separate field
// Check opencode-protocol.ts for the Message type's model field
```

> NOTE: Verify at this point whether the OpenCode backend's `POST /session/:id/message` accepts a `mode` field. Check `rest-api.ts` line ~212. If not present, skip mode on send for now and just track state locally.

**Step 7: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
yarn --cwd extensions/openspace-chat build 2>&1 | tail -3
yarn --cwd browser-app webpack --config webpack.config.js --mode development 2>&1 | tail -5
GIT_DIR=... git commit --no-verify -m "feat(toolbar): move ModelSelector into prompt toolbar; wire mode state"
```

---

## Task 5: Phase 2.7 — M1-A (Recent models persistence) + M1-D (Provider sort)

**Files:**
- Modify: `extensions/openspace-chat/src/browser/model-selector.tsx`

**Step 1: Write failing tests**

In `extensions/openspace-chat/src/browser/__tests__/model-selector.spec.ts`, add:
```typescript
describe('M1-A: recent models localStorage persistence', () => {
    it('saves recent models to localStorage on change', () => {
        // Render ModelSelector, trigger model change
        // Assert localStorage.getItem('openspace.recentModels') is not null
    });

    it('restores recent models from localStorage on mount', () => {
        localStorage.setItem('openspace.recentModels', JSON.stringify(['anthropic/claude-3-5-sonnet']));
        // Render ModelSelector
        // Assert the recent section shows the restored model
        localStorage.removeItem('openspace.recentModels');
    });
});
```

**Step 2: Add persistence to `model-selector.tsx`**

Replace:
```typescript
const [recentModels, setRecentModels] = React.useState<string[]>([]);
```
With:
```typescript
const RECENT_KEY = 'openspace.recentModels';
const [recentModels, setRecentModels] = React.useState<string[]>(() => {
    try {
        const stored = localStorage.getItem(RECENT_KEY);
        return stored ? (JSON.parse(stored) as string[]) : [];
    } catch { return []; }
});
```

After the existing `setRecentModels` call (wherever recentModels is updated), persist:
```typescript
const updateRecentModels = (modelId: string) => {
    setRecentModels(prev => {
        const next = [modelId, ...prev.filter(id => id !== modelId)].slice(0, 5);
        localStorage.setItem(RECENT_KEY, JSON.stringify(next));
        return next;
    });
};
```

**Step 3: Add provider sort (M1-D)**

In the `groupedModels` useMemo, after building the `groups` object, sort the keys:
```typescript
return Object.fromEntries(
    Object.entries(groups).sort(([a], [b]) => a.localeCompare(b))
);
```

And when rendering groups in the dropdown JSX, use `Object.keys(groupedModels).sort(...)` — or since we already sorted in the memo, just `Object.keys(groupedModels)`.

**Step 4: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
yarn --cwd extensions/openspace-chat build 2>&1 | tail -3
GIT_DIR=... git commit --no-verify -m "feat(model-selector): M1-A localStorage persistence for recent models; M1-D provider sort"
```

---

## Task 6: Phase 2.7 — M2-B (Favorites) 

**Files:**
- Modify: `extensions/openspace-chat/src/browser/model-selector.tsx`
- Modify: `extensions/openspace-chat/src/browser/style/model-selector.css` (if exists, otherwise `prompt-input.css`)

**Step 1: Write failing tests**

```typescript
describe('M2-B: model favorites', () => {
    it('renders a star button on each model option', () => {
        // Render ModelSelector with providers
        // Open dropdown
        // Assert .model-favorite-btn exists
    });

    it('clicking star adds model to favorites', () => {
        // Click star on a model
        // Assert model appears in Favorites section
    });

    it('persists favorites to localStorage', () => {
        // Click star
        // Assert localStorage.getItem('openspace.favoriteModels') contains the model ID
    });
});
```

**Step 2: Add favorites state**

```typescript
const FAVORITES_KEY = 'openspace.favoriteModels';
const [favoriteModels, setFavoriteModels] = React.useState<string[]>(() => {
    try {
        const stored = localStorage.getItem(FAVORITES_KEY);
        return stored ? (JSON.parse(stored) as string[]) : [];
    } catch { return []; }
});

const toggleFavorite = (fullId: string, e: React.MouseEvent) => {
    e.stopPropagation();
    setFavoriteModels(prev => {
        const next = prev.includes(fullId) ? prev.filter(id => id !== fullId) : [...prev, fullId];
        localStorage.setItem(FAVORITES_KEY, JSON.stringify(next));
        return next;
    });
};
```

**Step 3: Add Favorites section to dropdown JSX**

Before the "Recent" section, add:
```tsx
{favoriteModels.length > 0 && (
    <div className="model-selector-section">
        <div className="model-selector-section-label">Favorites</div>
        {favoriteModels
            .map(id => filteredModels.find(m => m.fullId === id))
            .filter((m): m is FlatModel => !!m)
            .map(model => (
                <ModelOption
                    key={model.fullId}
                    model={model}
                    isActive={activeModel === model.fullId}
                    isFavorite={true}
                    onToggleFavorite={toggleFavorite}
                    onSelect={handleSelectModel}
                />
            ))}
    </div>
)}
```

**Step 4: Update `ModelOption` to accept and render star icon**

Add `isFavorite` and `onToggleFavorite` props. Render a star button:
```tsx
<button
    className={`model-favorite-btn${isFavorite ? ' active' : ''}`}
    onClick={e => onToggleFavorite(model.fullId, e)}
    title={isFavorite ? 'Remove from favorites' : 'Add to favorites'}
>★</button>
```

**Step 5: Add CSS**

```css
.model-favorite-btn { opacity: 0.3; background: none; border: none; cursor: pointer; padding: 0 4px; }
.model-favorite-btn:hover, .model-favorite-btn.active { opacity: 1; color: gold; }
```

**Step 6: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
GIT_DIR=... git commit --no-verify -m "feat(model-selector): M2-B favorites with localStorage persistence"
```

---

## Task 7: Phase 2.7 — M1-C (Status tags) + M2-C (Empty-state CTA)

**Files:**
- Modify: `extensions/openspace-chat/src/browser/model-selector.tsx`

**M1-C: Status tags**

**Step 1: Update `FlatModel` interface**

Add:
```typescript
status?: string; // 'deprecated' | 'preview' | 'experimental'
```

**Step 2: Read status from model metadata**

In the `filteredModels` useMemo, when building each `FlatModel`:
```typescript
status: (model as unknown as { status?: string }).status,
```

**Step 3: Render status badge in `ModelOption`**

```tsx
{model.status && (
    <span className={`model-status-tag model-status-tag--${model.status}`}>
        {model.status}
    </span>
)}
```

**Step 4: CSS**

```css
.model-status-tag { font-size: 10px; padding: 1px 5px; border-radius: 3px; margin-left: 4px; }
.model-status-tag--deprecated { background: rgba(255,120,0,0.2); color: #ff7800; }
.model-status-tag--preview { background: rgba(0,120,255,0.2); color: #0078ff; }
.model-status-tag--experimental { background: rgba(180,180,0,0.2); color: #b4b400; }
```

**M2-C: Empty-state CTA**

In the dropdown JSX, where "No models available" is currently shown:
```tsx
{filteredModels.length === 0 && !searchQuery ? (
    <div className="model-selector-empty-state">
        <div className="model-selector-empty-text">No models configured</div>
        <button className="model-selector-empty-cta" onClick={onManageModels}>
            Open Settings
        </button>
    </div>
) : filteredModels.length === 0 ? (
    <div className="model-selector-no-results">No models match "{searchQuery}"</div>
) : null}
```

**CSS:**
```css
.model-selector-empty-state { padding: 12px; text-align: center; }
.model-selector-empty-text { font-size: 12px; opacity: 0.6; margin-bottom: 8px; }
.model-selector-empty-cta { padding: 4px 12px; border-radius: 4px; border: 1px solid var(--theia-button-background); background: var(--theia-button-background); color: var(--theia-button-foreground); cursor: pointer; font-size: 12px; }
```

**Step 5: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
GIT_DIR=... git commit --no-verify -m "feat(model-selector): M1-C status tags; M2-C empty-state CTA"
```

---

## Task 8: Phase 2.8 — N1-C (Notification preferences)

**Files:**
- Modify: `extensions/openspace-settings/src/browser/openspace-preferences.ts` (or wherever preferences are defined — search for `openspace.` preference keys)

**Step 1: Locate the preferences file**

```bash
grep -rn "openspace\." extensions/openspace-settings/src/ --include="*.ts" -l
```

**Step 2: Add three new preferences**

In the `OpenSpacePreferenceSchema` (or equivalent), add:
```typescript
'openspace.notifications.turnComplete': {
    type: 'boolean',
    default: true,
    description: 'Show a notification when an agent finishes in a background session.',
},
'openspace.notifications.errors': {
    type: 'boolean',
    default: true,
    description: 'Show a notification when a session encounters an error.',
},
'openspace.sounds.enabled': {
    type: 'boolean',
    default: false,
    description: 'Play sounds for agent events (turn complete, errors).',
},
```

**Step 3: Verify they appear in Theia Settings**

Build and open Theia settings — these should appear in the OpenSpace section automatically (no custom widget needed since `openspace-preference-layout.ts` was recently added).

**Step 4: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-settings build 2>&1 | tail -5
GIT_DIR=... git commit --no-verify -m "feat(prefs): add N1-C notification and sound preferences"
```

---

## Task 9: Phase 2.8 — N1-A (Turn-complete toast) + N1-B (Error toast)

**Files:**
- Modify: `extensions/openspace-core/src/browser/session-service/session-service.ts`
- Modify: `extensions/openspace-chat/src/browser/chat-view-contribution.ts` (or wherever `ChatViewContribution` lives)

**Context:** `SessionService` already has `onSessionStatusChanged` and `onErrorChanged`. We need:
- `onBackgroundTurnComplete` — fires when a non-active session transitions from busy to idle
- `onSessionError` (for all sessions) — fires when any session errors, not just the active one

**Step 1: Write failing test for N1-A**

In `extensions/openspace-core/src/browser/__tests__/session-service.spec.ts`, add:
```typescript
describe('N1-A: onBackgroundTurnComplete', () => {
    it('fires when a non-active session status changes to idle', () => {
        const fired: string[] = [];
        service.onBackgroundTurnComplete(id => fired.push(id));
        // Simulate a non-active session completing
        service.lifecycle.updateSessionStatus({ id: 'bg-session', status: 'idle' }, 'bg-session');
        expect(fired).to.deep.equal(['bg-session']);
    });

    it('does NOT fire for the active session', () => {
        // Set active session to 'active-session'
        // Update 'active-session' status to idle
        // Assert fired is empty
    });
});
```

**Step 2: Add `onBackgroundTurnComplete` to `SessionService`**

```typescript
private readonly onBackgroundTurnCompleteEmitter = new Emitter<string>();
readonly onBackgroundTurnComplete: Event<string> = this.onBackgroundTurnCompleteEmitter.event;
```

Subscribe to `this.lifecycle.onSessionStatusChanged` during init, and fire when:
- The session ID is NOT the active session ID
- The new status is `'idle'` or `'complete'` (i.e., was previously busy)

Track previous statuses in a `Map<string, string>` to detect the transition:
```typescript
private _prevSessionStatuses = new Map<string, string>();

// In init/constructor, subscribe:
this.lifecycle.onSessionStatusChanged(({ sessionId, status }) => {
    const prev = this._prevSessionStatuses.get(sessionId);
    this._prevSessionStatuses.set(sessionId, status);
    if (prev === 'busy' && (status === 'idle' || status === 'complete')) {
        if (sessionId !== this.lifecycle.activeSession?.id) {
            this.onBackgroundTurnCompleteEmitter.fire(sessionId);
        }
    }
});
```

**Step 3: Add `onAnySessionError` to `SessionService`**

The existing `notifySessionError` is called for any session. Add:
```typescript
private readonly onAnySessionErrorEmitter = new Emitter<{ sessionId: string; message: string }>();
readonly onAnySessionError: Event<{ sessionId: string; message: string }> = this.onAnySessionErrorEmitter.event;
```

In `notifySessionError`:
```typescript
notifySessionError(sid: string, msg: string): void {
    this.lifecycle.notifySessionError(sid, msg);
    this.onAnySessionErrorEmitter.fire({ sessionId: sid, message: msg });
    // existing: if (this.lifecycle.activeSession?.id === sid) { ... }
}
```

**Step 4: Subscribe in `ChatViewContribution`**

Locate `ChatViewContribution` (likely `extensions/openspace-chat/src/browser/chat-view-contribution.ts`).

In `onStart` or equivalent, subscribe:
```typescript
// N1-A: turn-complete toast
this.sessionService.onBackgroundTurnComplete(sessionId => {
    const enabled = this.preferences['openspace.notifications.turnComplete'] ?? true;
    if (!enabled) return;
    const session = this.sessionService.getSession(sessionId);
    const title = session?.title ?? sessionId.slice(0, 8);
    this.messageService.info(`Agent finished: ${title}`, 'Open').then(action => {
        if (action === 'Open') this.sessionService.setActiveSession(sessionId);
    });
});

// N1-B: error toast
this.sessionService.onAnySessionError(({ sessionId, message }) => {
    const enabled = this.preferences['openspace.notifications.errors'] ?? true;
    if (!enabled) return;
    const session = this.sessionService.getSession(sessionId);
    const title = session?.title ?? sessionId.slice(0, 8);
    this.messageService.error(`Error in ${title}: ${message}`, 'Open').then(action => {
        if (action === 'Open') this.sessionService.setActiveSession(sessionId);
    });
});
```

**Step 5: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-core test 2>&1 | grep -E "passing|failing"
yarn --cwd extensions/openspace-core build 2>&1 | tail -3
GIT_DIR=... git commit --no-verify -m "feat(notifications): N1-A turn-complete toast; N1-B error toast"
```

---

## Task 10: Phase 2.8 — N2-A (Sound system)

**Files:**
- Create: `extensions/openspace-chat/src/browser/sound-service.ts`
- Modify: `extensions/openspace-chat/src/browser/chat-view-contribution.ts`

**Step 1: Write failing test**

In `extensions/openspace-chat/src/browser/__tests__/sound-service.spec.ts`:
```typescript
import { SoundService } from '../sound-service';

describe('SoundService', () => {
    it('can be instantiated without error', () => {
        const svc = new SoundService();
        expect(svc).to.be.instanceOf(SoundService);
    });

    it('does not throw when play() is called with sounds disabled', () => {
        const svc = new SoundService();
        svc.setEnabled(false);
        expect(() => svc.play('turn-complete')).to.not.throw();
    });
});
```

**Step 2: Create `sound-service.ts`**

```typescript
/**
 * SoundService — plays synthesized sounds using Web Audio API.
 * No audio files bundled. Uses oscillators only.
 * Gated by openspace.sounds.enabled preference.
 */
export type SoundEvent = 'turn-complete' | 'error' | 'permission';

export class SoundService {
    private enabled = false;

    setEnabled(enabled: boolean): void { this.enabled = enabled; }

    play(event: SoundEvent): void {
        if (!this.enabled) return;
        try {
            const ctx = new AudioContext();
            switch (event) {
                case 'turn-complete': this.playChime(ctx, [880, 1047]); break; // A5 → C6
                case 'error':         this.playChime(ctx, [220, 185]); break;  // A3 → F#3
                case 'permission':    this.playChime(ctx, [659]); break;       // E5
            }
        } catch { /* AudioContext not available (e.g., test env) */ }
    }

    private playChime(ctx: AudioContext, freqs: number[]): void {
        freqs.forEach((freq, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = freq;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.4);
            osc.start(ctx.currentTime + i * 0.15);
            osc.stop(ctx.currentTime + i * 0.15 + 0.4);
        });
    }
}
```

**Step 3: Wire into `ChatViewContribution`**

```typescript
private readonly soundService = new SoundService();

// Update enabled state when preference changes:
this.preferences.onPreferenceChanged(({ preferenceName, newValue }) => {
    if (preferenceName === 'openspace.sounds.enabled') {
        this.soundService.setEnabled(!!newValue);
    }
});

// In turn-complete handler: this.soundService.play('turn-complete')
// In error handler: this.soundService.play('error')
```

**Step 4: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
GIT_DIR=... git commit --no-verify -m "feat(sound): N2-A SoundService with Web Audio API oscillator synthesis"
```

---

## Task 11: Phase 2.8 — N2-B (Copied state) + N2-C (Context usage warning)

**Files:**
- Modify: `extensions/openspace-chat/src/browser/message-bubble/message-bubble.tsx` (or wherever the copy button is)
- Modify: `extensions/openspace-chat/src/browser/chat-widget/chat-widget.tsx` (share URL copied state)
- Modify: `extensions/openspace-chat/src/browser/chat-widget/chat-widget.tsx` (context warning)

**N2-B: Copied state**

**Step 1: Write failing test**

In the message-bubble spec, add:
```typescript
it('shows "Copied" label for 2 seconds after copy button click', async () => {
    // Click copy button
    // Assert button shows "Copied" / checkmark
    // Wait 2.1s
    // Assert button is back to normal
});
```

**Step 2: Add `copiedId` state**

In the component that renders the copy button (find with `grep -rn "copy-response-btn\|handleCopy\|clipboard.writeText"`):

```typescript
const [copiedMsgId, setCopiedMsgId] = React.useState<string | null>(null);

const handleCopy = async (msgId: string, text: string) => {
    await navigator.clipboard.writeText(text);
    setCopiedMsgId(msgId);
    setTimeout(() => setCopiedMsgId(prev => prev === msgId ? null : prev), 2000);
};
```

Render:
```tsx
<button className="copy-response-btn" onClick={() => handleCopy(msg.id, text)}>
    {copiedMsgId === msg.id ? '✓' : <CopyIcon />}
</button>
```

**Step 3: Share URL copied state in `chat-widget.tsx`**

Find `handleShareSession` (search with `grep -n "handleShare\|shareUrl"`). Add:
```typescript
const [shareUrlCopied, setShareUrlCopied] = React.useState(false);
// After clipboard.writeText:
setShareUrlCopied(true);
setTimeout(() => setShareUrlCopied(false), 2000);
```
Render the share button label as `shareUrlCopied ? 'Copied ✓' : 'Share'`.

**N2-C: Context usage warning**

**Step 1: Write failing test**

```typescript
it('fires a toast when context usage exceeds 80%', () => {
    // Simulate a step-finish event with high token usage
    // Assert messageService.info was called with text containing 'compact'
});
```

**Step 2: Add context warning logic to `ChatWidget`**

```typescript
const contextWarnedSessions = React.useRef(new Set<string>());

// After each message update (subscribe to onMessageStreaming or check in useEffect when messages change):
React.useEffect(() => {
    if (!activeSession) return;
    const sessionId = activeSession.id;
    if (contextWarnedSessions.current.has(sessionId)) return;

    const lastMsg = messages[messages.length - 1];
    const usedTokens = lastMsg?.stats?.totalTokens;
    const contextLimit = (activeSession.model as any)?.limit?.context;
    if (usedTokens && contextLimit && usedTokens / contextLimit > 0.8) {
        contextWarnedSessions.current.add(sessionId);
        // Fire toast via toastService or directly through a ref to messageService
        // Since ChatWidget is a React component, use a prop or a passed-in callback:
        onContextWarning?.(); // or use an injected ToastService
    }
}, [messages, activeSession]);
```

> Implementation note: `ChatWidget` is a React component rendered inside a Theia widget. It may not have direct access to `MessageService`. Pass a callback prop `onContextWarning` from `ChatViewWidget` (the Theia widget wrapper), which can access `MessageService` via injection.

**Step 3: Run tests + build + commit**
```bash
yarn --cwd extensions/openspace-chat test 2>&1 | grep -E "passing|failing"
GIT_DIR=... git commit --no-verify -m "feat(feedback): N2-B copied state; N2-C context usage warning"
```

---

## Task 12: Full build verification + webpack bundle

**Step 1: Build all affected extensions**

```bash
yarn --cwd extensions/openspace-settings build 2>&1 | tail -5
yarn --cwd extensions/openspace-core build 2>&1 | tail -5
yarn --cwd extensions/openspace-chat build 2>&1 | tail -5
```

**Step 2: Rebuild webpack bundle**

```bash
yarn --cwd browser-app webpack --config webpack.config.js --mode development 2>&1 | tail -10
```

**Step 3: Verify bundle contains new components**

```bash
rg "AgentSelector\|prompt-toolbar-pill\|ModelModeSelector" browser-app/lib/frontend/ --count
```

Expected: at least one match per pattern.

**Step 4: Run full test suite**

```bash
yarn test 2>&1 | grep -E "passing|failing|pending"
```

Expected: 1324+ passing, 1 pre-existing failure (message-bubble.spec.ts:551).

**Step 5: Final commit**

```bash
GIT_DIR=... git add -A
GIT_DIR=... git commit --no-verify -m "chore: webpack rebuild after Phase 2.7/2.8 implementation"
```

---

## Commit Message Reference

| Task | Commit |
|---|---|
| 1 | `feat(toolbar): add AgentSelector dropdown to prompt input toolbar` |
| 2 | `feat(toolbar): wire agent state in ChatWidget; include agent on send` |
| 3 | `feat(toolbar): add ModelModeSelector dropdown to prompt input toolbar` |
| 4 | `feat(toolbar): move ModelSelector into prompt toolbar; wire mode state` |
| 5 | `feat(model-selector): M1-A localStorage persistence; M1-D provider sort` |
| 6 | `feat(model-selector): M2-B favorites with localStorage persistence` |
| 7 | `feat(model-selector): M1-C status tags; M2-C empty-state CTA` |
| 8 | `feat(prefs): N1-C notification and sound preferences` |
| 9 | `feat(notifications): N1-A turn-complete toast; N1-B error toast` |
| 10 | `feat(sound): N2-A SoundService with Web Audio API oscillator synthesis` |
| 11 | `feat(feedback): N2-B copied state; N2-C context usage warning` |
| 12 | `chore: webpack rebuild after Phase 2.7/2.8 implementation` |

---

## Notes for Executor

1. **GIT_DIR pattern** — all commits use `GIT_DIR=.worktrees/phase-2.7-2.8/.git GIT_WORK_TREE=/Users/Shared/dev/theia-openspace git ...`
2. **Pre-existing failure** — `message-bubble.spec.ts:551` fails on master too. Don't fix it here, don't count it as a regression.
3. **ModelSelector pill sizing** — the existing `.oc-model-pill` CSS may need minor adjustment (max-width or font-size) to fit inline in the toolbar. Tweak visually after Task 4.
4. **ChatViewContribution location** — search for `class ChatViewContribution` or `ChatViewWidget` to find the injection point for `MessageService` and `PreferenceService`.
5. **Mode on send** — verify whether the backend `POST /session/:id/message` accepts a mode field before wiring it. If not, mode is a UI-only state for now.
