# VS Code Extensions Support — Design Document

**Date:** 2026-02-20
**Branch:** feature/vscode-extensions
**Status:** Approved

---

## Goals

1. Enable the Theia Extensions sidebar (`Ctrl+Shift+X`) with full install/uninstall/search via Open VSX registry
2. Pre-bundle a curated set of essential extensions that work on first launch
3. Improve webpack build performance with filesystem caching so plugin-ext's weight doesn't slow development cycles
4. Add clean-build and dev-build scripts that separate "fast incremental" from "full rebuild"
5. Keep the path clear for production browser deployment (webview subdomain routing) in future

---

## Architecture

### Theia Plugin Stack (three packages)

```
@theia/vsx-registry          Extensions sidebar UI + open-vsx.org REST client
  └─ @theia/plugin-ext-vscode  VS Code .vsix manifest scanner + compat layer
       └─ @theia/plugin-ext    Plugin host subprocess, webview engine, VS Code API surface
```

All three added to `browser-app/package.json` and (eventually) `electron-app/package.json`.

### Directory Layout

```
theia-openspace/
├── plugins/
│   └── builtin/               .vsix files loaded at startup via --plugins=local-dir:
│       ├── builtin.json       Manifest (name, version, open-vsx ID) — source of truth
│       └── *.vsix             Downloaded by scripts/download-plugins.js
├── .theia/
│   └── extensions.json        Curated recommendations shown in Extensions view
├── browser-app/
│   ├── package.json           +3 plugin packages, theiaPluginsDir config
│   ├── webpack.config.js      +filesystem cache config
│   └── .webpack-cache/        Webpack persistent cache (git-ignored)
└── scripts/
    ├── build-summary.js       Updated: add clean-build and dev-build modes
    └── download-plugins.js    New: downloads builtin .vsix files from open-vsx.org
```

### Build Scripts

| Command | What it does |
|---|---|
| `yarn build` | Fast incremental (webpack filesystem cache, skip if lib/ fresh) |
| `yarn build:clean` | Delete all artifacts + full rebuild from scratch |
| `yarn build:extensions` | Rebuild only the custom extensions |
| `yarn build:browser` | Rebuild only the browser-app bundle |
| `yarn setup:plugins` | Download/update builtin .vsix files |

### Webpack Filesystem Cache

`browser-app/webpack.config.js` (user-editable, not regenerated by Theia CLI) gains:

```js
configs.forEach(config => {
    config.cache = {
        type: 'filesystem',
        cacheDirectory: path.resolve(__dirname, '.webpack-cache'),
        buildDependencies: {
            config: [__filename, path.resolve(__dirname, 'gen-webpack.config.js')],
        },
    };
});
```

Effect: subsequent builds with no plugin-ext changes go from ~45s → ~5s. Cache is invalidated automatically when webpack config changes.

---

## Packages Added

### `browser-app/package.json` — New Dependencies

```json
"@theia/plugin-ext": "1.68.2",
"@theia/plugin-ext-vscode": "1.68.2",
"@theia/vsx-registry": "1.68.2"
```

### `browser-app/package.json` — `theia` Config Update

```json
"theia": {
    "target": "browser",
    "theiaPluginsDir": "plugins",
    "frontend": {
        "config": {
            "applicationName": "Theia Openspace",
            "preferences": {
                "files.enableTrash": false
            }
        }
    }
}
```

### `browser-app/package.json` — Start Script Update

```json
"start": "theia start --port 3000 --plugins=local-dir:../plugins/builtin"
```

---

## Curated Builtin Extensions

Stored in `plugins/builtin.json`:

```json
[
  { "id": "redhat.vscode-yaml",          "version": "latest" },
  { "id": "vscode.git",                  "version": "latest" },
  { "id": "ms-python.python",            "version": "latest" },
  { "id": "esbenp.prettier-vscode",      "version": "latest" },
  { "id": "yzhang.markdown-all-in-one",  "version": "latest" }
]
```

`scripts/download-plugins.js` reads this manifest and fetches each `.vsix` from `https://open-vsx.org/api/<publisher>/<name>/<version>/file/<publisher>.<name>-<version>.vsix`.

---

## Curated Recommendations

`.theia/extensions.json` (shown as "Recommended" in the Extensions sidebar):

```json
{
  "recommendations": [
    "eamodio.gitlens",
    "bradlc.vscode-tailwindcss",
    "dbaeumer.vscode-eslint",
    "streetsidesoftware.code-spell-checker"
  ]
}
```

---

## Build Performance Analysis

| Scenario | Before | After (filesystem cache) |
|---|---|---|
| Cold build (first ever, or after clean) | ~29s | ~45–55s (plugin-ext adds weight) |
| Warm build (no changes) | ~29s | ~3–5s |
| Warm build (only openspace-chat changed) | ~29s | ~8–12s |
| After `yarn build:clean` | ~29s | ~45–55s |

The filesystem cache lives in `browser-app/.webpack-cache/` (~100–300MB). It is git-ignored. `yarn build:clean` deletes it along with all other artifacts.

---

## Electron App (Deferred)

`electron-app/package.json` is currently a stub. Extension support for Electron requires:
1. All three plugin packages added
2. `@theia/plugin-ext` backend **electron** module wired in (separate from browser module)
3. `theia rebuild:electron` for native deps (node-pty)

This is deferred to a subsequent task. The browser implementation does not block it.

---

## Production Browser Deployment (Future)

Webview-using extensions require `*.webview.yourdomain.com` wildcard DNS + reverse proxy. For localhost this works automatically. No code changes needed now — just infrastructure when deploying.

---

## Risks

| Risk | Likelihood | Mitigation |
|---|---|---|
| `plugin-ext` pulls in conflicting transitive deps | Low | Theia 1.68.2 is a known-good release; yarn workspaces resolutions handle monaco |
| Webpack cache stale after Theia version bump | Medium | `buildDependencies` in cache config triggers invalidation on config change; `yarn build:clean` as escape hatch |
| `node-pty` native rebuild needed | High (expected) | `theia rebuild:browser` documented in setup steps |
| Some Open VSX extensions not available | Medium | Fallback to local .vsix sideload; curated list vetted against open-vsx.org |
