# R1 Hygiene Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Resolve all Critical (C1–C3) and remaining R1 Hygiene items (I5, I8, I9, M13) from the 2026-02-27 code review.

**Architecture:** Seven independent fixes, each touching 1–3 files. No shared dependencies between tasks — they can be committed independently. All changes are in `extensions/openspace-core/` and `extensions/openspace-chat/`.

**Tech Stack:** TypeScript, Theia DI, Node.js `fs.promises`, DOMPurify, Express.

**Build target:** Theia currently runs from `.worktrees/voice-features/`. After browser extension changes, rebuild webpack there.

---

### Task 1: I9 — Fix hardcoded `/bin/bash` in opencode-proxy.ts

**Files:**
- Modify: `extensions/openspace-core/src/node/opencode-proxy.ts:1295`

**Step 1: Make the fix**

In `opencode-proxy.ts:1295`, replace:
```typescript
shell: '/bin/bash',
```
With:
```typescript
shell: process.platform === 'win32'
    ? (process.env.COMSPEC || 'cmd.exe')
    : (process.env.SHELL || '/bin/sh'),
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit -p extensions/openspace-core/tsconfig.json`
Expected: No errors.

**Step 3: Commit**

```bash
git add extensions/openspace-core/src/node/opencode-proxy.ts
git commit -m "fix(proxy): use platform-aware shell instead of hardcoded /bin/bash (I9)"
```

---

### Task 2: M13 — Replace `console.log` with logger in hub-mcp.ts

**Files:**
- Modify: `extensions/openspace-core/src/node/hub-mcp.ts`
- Modify: `extensions/openspace-core/src/node/hub.ts` (pass logger to constructor)

**Context:** `OpenSpaceMcpServer` is a plain class (not Theia injectable). It doesn't have access to Theia's `ILogger`. The parent `OpenSpaceHub` (which IS injectable) has `@inject(ILogger) protected readonly logger!: ILogger;`. We need to pass the logger down through the constructor.

**Step 1: Add logger parameter to `OpenSpaceMcpServer` constructor**

In `hub-mcp.ts`, add a `Console`-compatible logger interface and accept it in the constructor:

```typescript
// After the existing imports (around line 20), add:
/** Minimal logger interface — compatible with Theia ILogger and console. */
interface Logger {
    info(message: string, ...args: unknown[]): void;
    warn(message: string, ...args: unknown[]): void;
    error(message: string, ...args: unknown[]): void;
    debug(message: string, ...args: unknown[]): void;
}
```

Add `private readonly logger: Logger;` as a field. Update the constructor (line 98):

```typescript
constructor(workspaceRoot: string, logger?: Logger) {
    this.workspaceRoot = workspaceRoot;
    this.logger = logger ?? console;
    // ... rest unchanged
}
```

**Step 2: Replace all `console.log` / `console.error` with `this.logger`**

Replace every instance:
- `console.log(...)` → `this.logger.info(...)`
- `console.error(...)` → `this.logger.error(...)`

There are ~12 instances across lines 103, 350, 354, 356, 380, 382, 385, 445, 450, 471, and the constructor error handler at line 103.

**Step 3: Pass logger from `OpenSpaceHub` in hub.ts**

In `hub.ts` line 166, change:
```typescript
this.mcpServer = new OpenSpaceMcpServer(workspaceRoot);
```
To:
```typescript
this.mcpServer = new OpenSpaceMcpServer(workspaceRoot, this.logger);
```

The `this.logger` field already exists: `hub.ts:71` has `@inject(ILogger) protected readonly logger!: ILogger;`. Theia's `ILogger` has `info()`, `warn()`, `error()`, `debug()` methods that match our interface.

**Step 4: Verify TypeScript compiles**

Run: `npx tsc --noEmit -p extensions/openspace-core/tsconfig.json`
Expected: No errors.

**Step 5: Commit**

```bash
git add extensions/openspace-core/src/node/hub-mcp.ts extensions/openspace-core/src/node/hub.ts
git commit -m "fix(hub-mcp): replace console.log with structured logger (M13/E13)"
```

---

### Task 3: C2 — Add ReDoS protection in `searchFiles`

**Files:**
- Modify: `extensions/openspace-core/src/node/hub-mcp.ts` (the `searchFiles` method, lines 863-930)

**Context:** `new RegExp(pattern)` at line 875 takes raw user input. While there's a 5s deadline, a pathological regex can spike CPU and block the event loop for other requests during that entire window. We'll add a lightweight regex complexity check.

**Step 1: Add a `isSafeRegex` helper function**

Add above the `searchFiles` method (or at the top of the file, after imports):

```typescript
/**
 * Lightweight ReDoS guard: rejects patterns with nested quantifiers
 * that cause exponential backtracking (e.g., `(a+)+`, `(a|b)*+`).
 * Not a complete ReDoS detector, but catches the most common patterns.
 */
function isSafeRegex(pattern: string): boolean {
    // Reject nested quantifiers: a quantifier immediately following a group with a quantifier
    // Matches patterns like (x+)+, (x*)+, (x+)*, etc.
    if (/\([^)]*[+*]\)[+*{]/.test(pattern)) return false;
    // Reject excessive alternation depth with quantifiers
    if (/\([^)]*\|[^)]*\)[+*{]/.test(pattern)) return false;
    // Reject extremely long patterns (likely generated/malicious)
    if (pattern.length > 200) return false;
    return true;
}
```

**Step 2: Add the guard in `searchFiles` before `new RegExp(pattern)`**

At line 873-879, change from:
```typescript
let regex: RegExp;
try {
    regex = new RegExp(pattern);
} catch {
    regex = new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
}
```

To:
```typescript
if (!isSafeRegex(pattern)) {
    // Fall back to literal string search for unsafe patterns
    return [];
}
let regex: RegExp;
try {
    regex = new RegExp(pattern);
} catch {
    regex = new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
}
```

**Step 3: Verify TypeScript compiles**

Run: `npx tsc --noEmit -p extensions/openspace-core/tsconfig.json`
Expected: No errors.

**Step 4: Commit**

```bash
git add extensions/openspace-core/src/node/hub-mcp.ts
git commit -m "fix(hub-mcp): add ReDoS guard to searchFiles regex (C2)"
```

---

### Task 4: C3 — Convert synchronous fs calls to async in hub-mcp.ts and artifact-store.ts

**Files:**
- Modify: `extensions/openspace-core/src/node/hub-mcp.ts` (searchFiles method, lines 863-930)
- Modify: `extensions/openspace-core/src/node/artifact-store.ts` (chokidar handler, line 67)

**Step 1: Convert `searchFiles` to async in hub-mcp.ts**

The `searchFiles` method (line 863) is synchronous. Convert to async:

Change signature from:
```typescript
private searchFiles(dirPath: string, pattern: string, globFilter?: string): string[] {
```
To:
```typescript
private async searchFiles(dirPath: string, pattern: string, globFilter?: string): Promise<string[]> {
```

Inside the `walk` inner function, convert from sync to async:

Change `walk` from:
```typescript
const walk = (dir: string, depth: number): void => {
```
To:
```typescript
const walk = async (dir: string, depth: number): Promise<void> => {
```

Replace sync calls:
- `fs.readdirSync(dir, { withFileTypes: true })` → `await fs.promises.readdir(dir, { withFileTypes: true })`
- `fs.statSync(full)` → `await fs.promises.stat(full)`
- `fs.readFileSync(full, 'utf-8')` → `await fs.promises.readFile(full, 'utf-8')`

At the call site `walk(full, depth + 1)`, change to `await walk(full, depth + 1)`.

**Step 2: Update the caller of `searchFiles`**

Find where `searchFiles` is called (it's in the FILE_SEARCH tool handler). Add `await` since the method is now async. It's likely already in an async handler so this should just need an `await` prefix.

**Step 3: Convert `fs.readFileSync` to async in artifact-store.ts**

In `artifact-store.ts:61-79`, the chokidar `change` handler uses `fs.readFileSync` at line 67. Convert:

Change:
```typescript
this.watcher.on('change', (absolutePath: string) => {
    const rel = path.relative(this.projectRoot, absolutePath).replace(/\\/g, '/');
    if (this.lastWrittenHash.has(rel)) {
        try {
            const current = fs.readFileSync(absolutePath);
```

To:
```typescript
this.watcher.on('change', async (absolutePath: string) => {
    const rel = path.relative(this.projectRoot, absolutePath).replace(/\\/g, '/');
    if (this.lastWrittenHash.has(rel)) {
        try {
            const current = await fs.promises.readFile(absolutePath);
```

Chokidar callbacks support async functions — the return Promise is simply ignored (fire-and-forget), which is fine for this event handler.

**Step 4: Verify TypeScript compiles**

Run: `npx tsc --noEmit -p extensions/openspace-core/tsconfig.json`
Expected: No errors.

**Step 5: Commit**

```bash
git add extensions/openspace-core/src/node/hub-mcp.ts extensions/openspace-core/src/node/artifact-store.ts
git commit -m "fix(hub-mcp, artifact-store): convert sync fs calls to async (C3)"
```

---

### Task 5: C1/E2 — Move `getMcpConfig()` to the backend via RPC

**Files:**
- Modify: `extensions/openspace-core/src/common/opencode-protocol.ts` (add `getMcpConfig` to interface)
- Modify: `extensions/openspace-core/src/node/opencode-proxy.ts` (implement backend method)
- Modify: `extensions/openspace-core/src/browser/session-service.ts` (replace fs-based impl with RPC call, remove `fs` import)

**Step 1: Add `getMcpConfig` to the `OpenCodeService` interface**

In `opencode-protocol.ts`, inside the `OpenCodeService` interface (around line 273, before the closing brace), add:

```typescript
    // MCP config reading (Node-side, resolves C1/E2)
    getMcpConfig(directory: string): Promise<Record<string, unknown> | undefined>;
```

**Step 2: Implement in `OpenCodeProxy`**

In `opencode-proxy.ts`, add the implementation method (near other config methods around line 550):

```typescript
async getMcpConfig(directory: string): Promise<Record<string, unknown> | undefined> {
    const configPath = path.join(directory, 'opencode.json');
    try {
        const raw = await fs.promises.readFile(configPath, 'utf-8');
        const config = JSON.parse(raw);
        if (config.mcp) {
            this.logger.info('[OpenCodeProxy] Found MCP config in: ' + configPath);
            return config.mcp as Record<string, unknown>;
        }
        this.logger.debug('[OpenCodeProxy] No mcp section in: ' + configPath);
        return undefined;
    } catch {
        this.logger.debug('[OpenCodeProxy] No opencode.json at: ' + configPath);
        return undefined;
    }
}
```

Note: `opencode-proxy.ts` already imports `fs` (it's a Node-side file) and `path`. Check that `fs.promises` is used (it is throughout the file for other methods).

**Step 3: Replace browser-side implementation in `session-service.ts`**

In `session-service.ts`:

1. **Remove line 33:** `import * as fs from 'fs';`
2. **Replace the `getMcpConfig()` method** (lines 331-361) with:

```typescript
    /**
     * Read MCP config from opencode.json via backend RPC.
     * Resolves C1/E2 — no filesystem access in the browser bundle.
     */
    private async getMcpConfig(): Promise<Record<string, unknown> | undefined> {
        try {
            const worktree = this._activeProject?.worktree;
            if (!worktree) {
                this.logger.warn('[SessionService] No worktree available for MCP config');
                return undefined;
            }
            return await this.openCodeService.getMcpConfig(worktree);
        } catch (error) {
            this.logger.error('[SessionService] Error reading MCP config: ' + (error instanceof Error ? error.message : String(error)));
            return undefined;
        }
    }
```

Note: The method signature changes from sync to async. Find any callers and ensure they `await` it. Check the call site (search for `this.getMcpConfig()` in session-service.ts).

**Step 4: Verify TypeScript compiles**

Run: `npx tsc --noEmit -p extensions/openspace-core/tsconfig.json`
Expected: No errors. This also verifies that no other code depends on the `fs` import.

**Step 5: Commit**

```bash
git add extensions/openspace-core/src/common/opencode-protocol.ts extensions/openspace-core/src/node/opencode-proxy.ts extensions/openspace-core/src/browser/session-service.ts
git commit -m "fix(session): move getMcpConfig to backend via RPC, remove fs import (C1/E2)"
```

---

### Task 6: I8 — Add pruning for stale localStorage entries in notification-service.ts

**Files:**
- Modify: `extensions/openspace-core/src/browser/notification-service.ts`

**Step 1: Add `pruneStaleEntries` method**

Add after the `incrementUnseen` method (after line 68):

```typescript
    /**
     * Remove entries for sessions that no longer exist.
     * Call this when the session list is loaded to prevent unbounded growth.
     */
    pruneStaleEntries(activeSessionIds: Set<string>): void {
        let changed = false;
        for (const sessionId of this._counts.keys()) {
            if (!activeSessionIds.has(sessionId)) {
                this._counts.delete(sessionId);
                changed = true;
            }
        }
        if (changed) {
            this._save();
        }
    }
```

**Step 2: Add to the interface**

In the `SessionNotificationService` interface (around line 34), add:

```typescript
    /** Prune entries for sessions that no longer exist. */
    pruneStaleEntries(activeSessionIds: Set<string>): void;
```

**Step 3: Call from SessionService after session list load**

In `session-service.ts`, find where sessions are loaded (the `getSessions` or `loadSessions` method). After sessions are successfully loaded, add:

```typescript
// Prune notification counts for deleted sessions
const activeIds = new Set(sessions.map(s => s.id));
this.notificationService.pruneStaleEntries(activeIds);
```

Note: Find the exact location by searching for where `getSessions` results are stored. The `notificationService` is already injected (search for `SessionNotificationService` usage in session-service.ts).

**Step 4: Verify TypeScript compiles**

Run: `npx tsc --noEmit -p extensions/openspace-core/tsconfig.json`
Expected: No errors.

**Step 5: Commit**

```bash
git add extensions/openspace-core/src/browser/notification-service.ts extensions/openspace-core/src/browser/session-service.ts
git commit -m "fix(notification): prune stale localStorage entries on session load (I8)"
```

---

### Task 7: I5 — Replace custom HTML sanitizer with DOMPurify

**Files:**
- Modify: `extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx` (lines 32-63)
- Modify: `extensions/openspace-chat/package.json` (add DOMPurify dependency)

**Step 1: Install DOMPurify**

Run: `yarn add dompurify && yarn add -D @types/dompurify`
(Run from the workspace root — yarn workspaces will handle the resolution.)

**Step 2: Replace the custom `sanitizeHtml` function**

In `prompt-input.tsx`, replace lines 32-63 with:

```typescript
import DOMPurify from 'dompurify';

/**
 * Sanitize HTML pasted into the prompt input.
 * Uses DOMPurify for battle-tested XSS prevention.
 * Preserves safe structural elements like spans (pills), divs, etc.
 */
function sanitizeHtml(html: string): string {
    return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'span', 'div', 'p'],
        ALLOWED_ATTR: ['class', 'data-agent', 'data-value', 'contenteditable'],
        KEEP_CONTENT: true,
    });
}
```

Note: The allowed tags list includes `span` and `div` because the prompt input uses pill elements (`<span class="mention-pill" data-agent="..." ...>`). The `data-agent`, `data-value`, and `contenteditable` attributes are needed for pill functionality. Check the existing code to see what attributes pills use before finalizing the list.

**Step 3: Verify TypeScript compiles**

Run: `npx tsc --noEmit -p extensions/openspace-chat/tsconfig.json`
Expected: No errors.

**Step 4: Verify the import works with Theia's webpack**

Since this is a browser extension, DOMPurify needs to be available in the webpack bundle. DOMPurify is a pure-JS library that works in browsers natively, so no special webpack config should be needed.

**Step 5: Commit**

```bash
git add extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx extensions/openspace-chat/package.json yarn.lock
git commit -m "fix(chat): replace custom HTML sanitizer with DOMPurify (I5)"
```

---

## Post-Implementation

After all 7 tasks are complete:

1. **Rebuild webpack** (browser extension changes in Tasks 5, 6, 7):
   ```bash
   yarn --cwd .worktrees/voice-features/browser-app webpack --config webpack.config.js --mode development
   ```

2. **Hard-refresh the browser** (Cmd+Shift+R)

3. **Run the E2E test suite** incrementally (Rule 4):
   Start with the most relevant spec files, then expand.

4. **Update the code review document** (`docs/reviews/CODE-REVIEW-2026-02-27.md`) to mark resolved items.

5. **Update agent memory** (`progress.md`, `active_context.md`).
