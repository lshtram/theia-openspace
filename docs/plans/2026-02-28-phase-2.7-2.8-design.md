---
id: DESIGN-PHASE-2.7-2.8
author: agent
status: APPROVED
date: 2026-02-28
---

# Design: Phase 2.7 Model Selector + Phase 2.8 Notifications & Prompt Toolbar Redesign

## Overview

Three interrelated areas of work:

1. **Prompt toolbar redesign** â€” move model selector + add agent selector + model mode selector into the existing prompt input toolbar row, matching the OpenCode client reference UX.
2. **Phase 2.7 model selector enhancements** â€” 5 remaining items (M1-A, M1-C, M1-D, M2-B, M2-C).
3. **Phase 2.8 notifications & feedback** â€” 6 items (N1-A through N2-C).

---

## Part 1: Prompt Toolbar Redesign

### Goal

Match the OpenCode client layout:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [multiline text input area]                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Build âˆ¨]  [âŠ• Claude Sonnet 4.6 âˆ¨]  [Default âˆ¨]  [@][/][ğŸ“] [â†‘]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

The toolbar (`prompt-input-toolbar`) becomes a two-group row:
- **Left group:** Agent selector, Model selector, Mode selector
- **Right group (existing):** `@`, `/`, attach, Send/Stop

### Components

#### `AgentSelector` (new â€” `agent-selector.tsx`)
- Inline dropdown pill, left-most position
- On mount: calls `listAgents()` (falls back to hardcoded `AVAILABLE_AGENTS`)
- State: `selectedAgent: AgentInfo | null` â€” owned by parent chat widget
- Behavior: selecting an agent sets the active agent for that session
- On send: agent is prepended as `AgentPart` to message parts (or passed as separate `agentId` param)
- Default: no agent selected (empty/default state shows "Build" or first agent)

#### `ModelModeSelector` (new â€” `model-mode-selector.tsx`)
- Inline dropdown pill, right-most of the three left controls
- Options: fetched dynamically from server per selected model
- Falls back to `["default"]` if no modes available
- State: `selectedMode: string` â€” owned by chat widget
- Displayed labels: "Default", "Think", "High" (normalized from server values)

#### `ModelSelector` (existing â€” relocated)
- **Moved** from `chat-header-bar.tsx` into the prompt toolbar
- Props unchanged; just rendered in a different position
- Pill trigger style adapts to inline toolbar context (existing `.oc-model-pill` styles may need minor sizing adjustments)
- The "Manage Models" footer link inside the dropdown opens Theia Preferences (no custom modal needed â€” preferences are already wired via `openspace-settings`)

#### State ownership
Agent, model, and mode state live in the **chat widget** (`chat-widget.tsx`), not inside PromptInput. They are passed to the toolbar via props. This keeps PromptInput focused on text entry.

```typescript
// In ChatWidget state:
selectedAgent: AgentInfo | null;
selectedModelId: string | null;
selectedMode: string;  // 'default' | 'think' | 'high' | ...
```

#### Header bar changes
- Remove `<ModelSelector>` from `chat-header-bar.tsx`
- Header bar retains: MCP status pill, New session button, Delete session button

### API: sending with agent

When `selectedAgent` is set, the agent name is passed as metadata with the message. The backend `POST /session/:id/message` already accepts `providerID`/`modelID` fields at the message level â€” an `agentID` field (or equivalent) needs to be verified against the OpenCode SDK. If not supported at message level, the agent is prepended as `@agentName` text in the message parts (existing behavior via `AgentPart`).

---

## Part 2: Phase 2.7 â€” Model Selector Enhancements

### M1-A: Recent Models Persistence
- `recentModels` array (max 5) is currently in-memory React state
- Add `useEffect` to persist to `localStorage` key `openspace.recentModels` on change
- Restore from `localStorage` on mount (parse JSON, validate structure)

### M1-C: Status Tags
- Read `status` field from model metadata (SDK `FlatModel` interface needs `status?: string` field added)
- Show small badge beside model name: "deprecated" (orange), "preview" (blue), "experimental" (yellow)
- Badge is optional â€” only shown when `status` is set

### M1-D: Provider Sort
- Sort provider group keys alphabetically when building `groupedModels`
- One-line comparator in the grouping logic

### M2-B: Favorites
- Add star icon to each `ModelOption` row
- Starred models appear in new "Favorites" section at top of dropdown (above "Recent")
- State: `favoriteModels: string[]` (model IDs), persisted to `localStorage` key `openspace.favoriteModels`
- Toggle: click star â†’ add/remove from favorites list

### M2-C: Empty-State CTA
- When `filteredModels.length === 0` and search is empty (i.e., no models configured):
  - Show: "No models configured"
  - Button: "Open Settings" â†’ calls `onManageModels()` (already wired to open Theia preferences)
- When search has a value but no matches: show "No models match '{query}'" (existing behavior)

---

## Part 3: Phase 2.8 â€” Notifications & Feedback

### N1-C: Notification Preferences (implement first â€” gates other items)
Add to `openspace-preferences.ts`:
- `openspace.notifications.turnComplete: boolean` (default: `true`)
- `openspace.notifications.errors: boolean` (default: `true`)
- `openspace.sounds.enabled: boolean` (default: `false`)

### N1-A: Turn-Complete Toast
- `SessionService` emits new `onBackgroundTurnComplete: Event<SessionInfo>` when a non-focused session transitions `busy â†’ idle`
- `ChatViewContribution` subscribes; fires `MessageService.info('Agent finished in session X', { actions: ['Open'] })`
- Gated by `openspace.notifications.turnComplete` preference

### N1-B: Error Toast
- `SessionService` emits new `onSessionError: Event<{ session: SessionInfo; error: string }>` (or reuse existing `onSessionError` if present)
- `ChatViewContribution` subscribes; fires `MessageService.error('Error in session X: ...', { actions: ['Open'] })`
- Gated by `openspace.notifications.errors` preference

### N2-A: Sound System (`SoundService`)
- New `SoundService` class using Web Audio API (`AudioContext`)
- No bundled audio files â€” pure oscillator synthesis
- Three sounds:
  - `turn-complete`: A5â†’C6 chime (ascending two-note)
  - `error`: A3â†’F#3 descending (two-note)
  - `permission`: E5 single tone (brief)
- Called from `ChatViewContribution` where toasts fire
- Gated by `openspace.sounds.enabled`

### N2-B: Copied State
- Share URL button: add `shareUrlCopied: boolean` state, reset after 2000ms
- Message copy button: same pattern â€” show "âœ“" for 2s
- Uses `setTimeout` + React state; no new dependencies

### N2-C: Context Usage Warning
- After each `step-finish` event, compute `usedTokens / contextLimit`
- If > 80% and this session hasn't warned yet (tracked via `Set<sessionId>` ref):
  - Fire `MessageService.info('Context usage above 80%. Consider running /compact')`
- Read `contextLimit` from `activeSession.model?.limit?.context`

---

## Files Affected (summary)

| File | Change |
|---|---|
| `prompt-input/prompt-input.tsx` | Add agent/model/mode controls to toolbar left group; extend props |
| `prompt-input/agent-selector.tsx` | New component |
| `prompt-input/model-mode-selector.tsx` | New component |
| `prompt-input/types.ts` | Add `agentId`, `modelMode` to `PromptInputProps` |
| `model-selector.tsx` | Add M1-A/M1-C/M1-D/M2-B/M2-C enhancements |
| `chat-widget/chat-header-bar.tsx` | Remove ModelSelector |
| `chat-widget/chat-widget.tsx` | Add agent/model/mode state; wire through |
| `openspace-preferences.ts` | Add N1-C notification/sound preferences |
| `session-service.ts` | Add N1-A/N1-B events |
| `chat-view-contribution.ts` | Subscribe to events, fire toasts |
| `sound-service.ts` | New â€” N2-A Web Audio sound service |
| `style/prompt-input.css` | Style left group pills in toolbar |
| `style/model-selector.css` | Minor sizing adjustments for inline toolbar context |
