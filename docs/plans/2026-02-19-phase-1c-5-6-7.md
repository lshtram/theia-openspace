# Phase 1C.5â€“1C.7 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Complete Phase 1C Code Hardening: fix E2E test flakiness (1C.5), apply T3 minor improvements (1C.6), and run the security validation checklist (1C.7).

**Architecture:** Changes span E2E test infrastructure (`tests/e2e/`), browser contributions (`extensions/openspace-core/src/browser/`, `extensions/openspace-chat/src/browser/`, `extensions/openspace-whiteboard/src/browser/`, `extensions/openspace-presentation/src/browser/`), and Node Hub config (`extensions/openspace-core/src/node/hub.ts`). No new DI tokens needed â€” `ILogger` and `MessageService` are already registered by Theia's core module and injected elsewhere in this codebase.

**Tech Stack:** TypeScript, Theia (`ILogger` from `@theia/core/lib/common/logger`, `MessageService` from `@theia/core/lib/common/message-service`), Playwright (E2E), Mocha + chai (unit tests), React

**Architecture notes:**
- `ILogger` in browser classes: use `@inject(ILogger)` decorator on a `protected readonly logger!: ILogger` field. Import from `@theia/core/lib/common/logger`. No `@optional()` â€” ILogger is always available. Unit test mocks: add `logger: { info: sinon.stub(), warn: sinon.stub(), error: sinon.stub() }` to the mock object.
- `MessageService` in `chat-widget.tsx` is **already injected** (`line 48`) â€” the `T3-10` fix just needs to call `this.messageService.info(...)` with confirm dialog pattern instead of `window.confirm()`.
- `crypto.randomUUID()` is available in browser context (Chromium 92+ / Node 15+) â€” no import needed.
- Hub allowed origins: read `process.env.OPENSPACE_HUB_ORIGINS` (comma-separated) at construction time, merge with defaults.
- E2E `waitForTimeout` replacements: Playwright's `waitForFunction` runs JS in the page context. The pattern `page.waitForFunction(() => condition, { timeout: N })` replaces a fixed `waitForTimeout` that was waiting for that condition.

**Test commands:**
- Unit: `yarn test:unit 2>&1 | tail -5` (must show 454+ passing, 0 failing)
- Build: `yarn build 2>&1 | tail -5` (must show zero TypeScript errors)

---

## Task 1: Replace `waitForTimeout` in `agent-control.spec.ts`

**Files:**
- Modify: `tests/e2e/agent-control.spec.ts`

**Context:** 5 `waitForTimeout` calls. After `injectMessageEvent`, tests wait for React to re-render before checking the DOM. After `triggerAgentCommand`, tests wait for the async command queue (50 ms delay in `processCommandQueue`). Replace with deterministic waits.

**Step 1: Read the file**

Open `tests/e2e/agent-control.spec.ts` and confirm the 5 locations:
- Line 133: `await page.waitForTimeout(500);` â€” after `injectMessageEvent`, before DOM check
- Line 178: `await page.waitForTimeout(300);` â€” same pattern (second inject test)
- Line 204: `await page.waitForTimeout(600);` â€” after `triggerAgentCommand` for path traversal test
- Line 242: `await page.waitForTimeout(600);` â€” after `triggerAgentCommand` for SSH key test
- Line 271: `await page.waitForTimeout(600);` â€” after `triggerAgentCommand` for editor.open test

**Step 2: Apply replacements**

Replace each `waitForTimeout` with a deterministic wait:

For lines 133 and 178 (waiting for React after message injection):
```typescript
// Replace: await page.waitForTimeout(500);
// With:
await page.waitForFunction(() => {
    // Wait until React has had a chance to flush (next animation frame completes)
    return document.readyState === 'complete';
}, { timeout: 3000 });
```

For lines 204, 242, and 271 (waiting for command queue to drain after `triggerAgentCommand`):
```typescript
// Replace: await page.waitForTimeout(600);
// With:
// The command queue processes with a 50ms delay. Wait for either the command
// to be recorded OR for 2 seconds (whichever comes first).
await page.waitForFunction(() => {
    const testApi = (window as any).__openspace_test__;
    return testApi?.getLastDispatchedCommand !== undefined;
}, { timeout: 2000 }).catch(() => { /* hook may not be available; test will skip below */ });
```

**Step 3: Verify no remaining `waitForTimeout` in this file**

```bash
grep -n "waitForTimeout" tests/e2e/agent-control.spec.ts
```
Expected: no output.

**Step 4: Commit**

```bash
git add tests/e2e/agent-control.spec.ts
git commit -m "fix(e2e): replace waitForTimeout with deterministic waits in agent-control.spec.ts (T2-27)"
```

---

## Task 2: Replace `waitForTimeout` in `verify-bugs.spec.ts`

**Files:**
- Modify: `tests/e2e/verify-bugs.spec.ts`

**Context:** 5 calls scattered across the file. Each has a specific semantic.

**Step 1: Read the file**

Open `tests/e2e/verify-bugs.spec.ts` and identify:
- Line 9: `await page.waitForTimeout(3000);` â€” "let it settle" after `#theia-app-shell` visible
- Line 13: `await page.waitForTimeout(1000);` â€” after clicking chat tab, before `waitForSelector`
- Line 25: `await page.waitForTimeout(2000);` â€” "Wait a little for auto-project selection to complete"
- Line 40: `await page.waitForTimeout(2000);` â€” "Give it a moment to auto-select project" 
- Line 63: `await page.waitForTimeout(3000);` â€” after `openChatWidget`, in SSE test

**Step 2: Apply replacements**

Line 9 (settle after shell load â€” wait until `.theia-main-container` or activity bar visible):
```typescript
// Replace: await page.waitForTimeout(3000); // let it settle
// With:
await page.waitForSelector('.theia-main-container, .theia-left-content-panel', { timeout: 10000 });
```

Line 13 (after clicking chat tab â€” already followed by `waitForSelector('.openspace-chat-widget')`):
```typescript
// Remove the waitForTimeout(1000) entirely â€” the following waitForSelector handles it
```

Line 25 (`openChatWithSession` â€” wait for auto-project selection):
```typescript
// Replace: await page.waitForTimeout(2000);
// With:
// Auto-project selection fires console logs; we can't intercept them here.
// Wait for the session dropdown to be rendered as a signal that initialization completed.
await page.waitForSelector('.session-dropdown-button', { timeout: 10000 });
```

Line 40 (Bug 1 test â€” auto-project selection):
```typescript
// Replace: await page.waitForTimeout(2000);
// With:
await page.waitForSelector('.session-dropdown-button', { timeout: 10000 });
```

Line 63 (SSE test â€” after `openChatWidget`):
```typescript
// Replace: await page.waitForTimeout(3000);
// With:
// Wait for the session dropdown to confirm widget is fully initialized
await page.waitForSelector('.session-dropdown-button', { timeout: 10000 });
```

**Step 3: Verify no remaining `waitForTimeout`**

```bash
grep -n "waitForTimeout" tests/e2e/verify-bugs.spec.ts
```
Expected: no output.

**Step 4: Commit**

```bash
git add tests/e2e/verify-bugs.spec.ts
git commit -m "fix(e2e): replace waitForTimeout with deterministic waits in verify-bugs.spec.ts (T2-27)"
```

---

## Task 3: Replace `waitForTimeout` in `session-list-autoload.spec.ts`

**Files:**
- Modify: `tests/e2e/session-list-autoload.spec.ts`

**Context:** 1 call at line 256. The comment says "Extra settle time to allow project/session auto-loading to complete â€” regression test for race condition."

**Step 1: Read lines 246â€“278 of the file**

Confirm: `await page.waitForTimeout(2000);` at line 256 is followed by chat widget open and dropdown assertion.

**Step 2: Replace**

```typescript
// Replace: await page.waitForTimeout(2000);
// With:
// Wait for the Theia backend service to complete project/session initialization.
// The session dropdown button renders immediately, but its data-test-sessions-count
// attribute is only set after sessions have loaded. Poll for it.
await page.waitForFunction(
    () => {
        const btn = document.querySelector('.session-dropdown-button');
        return btn !== null && btn.getAttribute('data-test-sessions-count') !== null;
    },
    { timeout: 15000 }
).catch(() => {
    // If sessions never load (e.g. no OpenCode server), the test below will assert on null
});
```

**Step 3: Verify**

```bash
grep -n "waitForTimeout" tests/e2e/session-list-autoload.spec.ts
```
Expected: no output.

**Step 4: Commit**

```bash
git add tests/e2e/session-list-autoload.spec.ts
git commit -m "fix(e2e): replace waitForTimeout with waitForFunction in session-list-autoload.spec.ts (T2-27)"
```

---

## Task 4: Fix route mock ordering in `session-management.spec.ts`

**Files:**
- Modify: `tests/e2e/session-management.spec.ts`

**Context:** Playwright matches the first registered `page.route()` handler. If a wildcard pattern like `**/api/**` is registered before a specific pattern like `**/api/sessions/123`, the wildcard captures all traffic and the specific mock never fires.

**Step 1: Audit route registrations**

Read `tests/e2e/session-management.spec.ts` fully. Find all `page.route(...)` calls. Check if any wildcard patterns are registered before specific ones.

**Step 2: Reorder and add comments**

The fix pattern:
```typescript
// IMPORTANT: Register routes from most-specific to least-specific.
// Playwright matches the FIRST registered handler. If a wildcard is registered first,
// it will capture traffic that should go to specific handlers.

// Specific routes first:
await page.route('**/v1/session/specific-endpoint', handler1);
// Wildcard catch-all last:
await page.route('**/v1/**', handler2);
```

Apply this ordering to all `page.route` registrations in the file.

**Step 3: Run unit tests (E2E tests can't run without live server)**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 4: Commit**

```bash
git add tests/e2e/session-management.spec.ts
git commit -m "fix(e2e): register specific route mocks before wildcards in session-management.spec.ts (T2-28)"
```

---

## Task 5: UUID for message IDs (T3-6)

**Files:**
- Modify: `extensions/openspace-core/src/browser/session-service.ts` (line 844)
- Modify: `extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx` (line 20)
- Modify: `extensions/openspace-core/src/node/hub-mcp.ts` (line 524)

**Context:** `session-service.ts:844` uses `Date.now()` for a temporary part ID. `prompt-input.tsx:20` uses `Date.now() + random` for part IDs. `hub-mcp.ts:524` uses `Date.now() + random` for request IDs. The risk: under concurrent use, `Date.now()` can collide across tabs or rapid calls. `crypto.randomUUID()` is available in both browser (Chromium 92+) and Node 15+ â€” no import needed.

**Step 1: Write a unit test verifying UUID format**

In `extensions/openspace-core/src/browser/__tests__/session-service.spec.ts`, read the file to find the test structure, then add to the appropriate `describe` block:

```typescript
it('should use UUID format (not Date.now) for optimistic message part IDs', () => {
    // Read the source and verify it uses crypto.randomUUID
    const src = require('fs').readFileSync(
        require('path').join(path.dirname(new URL(import.meta.url).pathname), '../session-service.ts'),
        'utf-8'
    );
    // Should NOT use Date.now() for temp-part IDs
    expect(src).not.to.match(/id.*temp-part.*Date\.now/);
    // Should use crypto.randomUUID() or similar
    expect(src).to.match(/temp-part.*randomUUID|randomUUID.*temp-part/);
});
```

Run: `yarn test:unit 2>&1 | tail -5` â€” Expected: FAIL (not yet using UUID).

**Step 2: Fix `session-service.ts:844`**

Find the line:
```typescript
id: `temp-part-${Date.now()}`,
```
Replace with:
```typescript
id: `temp-part-${crypto.randomUUID()}`,
```

**Step 3: Fix `prompt-input.tsx:20`**

Find:
```typescript
const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
```
Replace with:
```typescript
const generateId = () => crypto.randomUUID();
```

**Step 4: Fix `hub-mcp.ts:524`**

Find:
```typescript
const requestId = `${cmd}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
```
Replace with:
```typescript
const requestId = `${cmd}-${crypto.randomUUID()}`;
```

**Step 5: Run tests**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 6: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero TypeScript errors.

**Step 7: Commit**

```bash
git add extensions/openspace-core/src/browser/session-service.ts \
        extensions/openspace-chat/src/browser/prompt-input/prompt-input.tsx \
        extensions/openspace-core/src/node/hub-mcp.ts \
        extensions/openspace-core/src/browser/__tests__/session-service.spec.ts
git commit -m "fix(reliability): use crypto.randomUUID() instead of Date.now() for message IDs (T3-6)"
```

---

## Task 6: Hub allowed origins from environment variable (T3-8)

**Files:**
- Modify: `extensions/openspace-core/src/node/hub.ts` (around line 50)

**Context:** The `allowedOrigins` array in `hub.ts` is hardcoded to `localhost:3000/3001`. Production deployments at a different hostname would need a recompile. The fix: read `process.env.OPENSPACE_HUB_ORIGINS` (comma-separated list) and merge with the hardcoded defaults.

**Step 1: Write a unit test**

In `extensions/openspace-core/src/node/__tests__/hub-mcp.spec.ts`, read the file to see structure, then add:

```typescript
it('Hub allows origins from OPENSPACE_HUB_ORIGINS env var', () => {
    // Structural test: verify source reads the env var
    const src = require('fs').readFileSync(
        require('path').join(path.dirname(new URL(import.meta.url).pathname), '../hub.ts'),
        'utf-8'
    );
    expect(src).to.include('OPENSPACE_HUB_ORIGINS');
});
```

Run: `yarn test:unit 2>&1 | tail -5` â€” Expected: FAIL.

**Step 2: Apply the fix**

In `hub.ts`, find the `allowedOrigins` field declaration (around line 50):

```typescript
private readonly allowedOrigins: string[] = [
    'http://localhost:3000',
    'http://localhost:3001',
    'http://127.0.0.1:3000',
    'http://127.0.0.1:3001',
];
```

Replace with:

```typescript
private readonly allowedOrigins: string[] = (() => {
    const defaults = [
        'http://localhost:3000',
        'http://localhost:3001',
        'http://127.0.0.1:3000',
        'http://127.0.0.1:3001',
    ];
    const envOrigins = process.env['OPENSPACE_HUB_ORIGINS'];
    if (!envOrigins) {
        return defaults;
    }
    const extra = envOrigins.split(',').map(s => s.trim()).filter(Boolean);
    return [...new Set([...defaults, ...extra])];
})();
```

**Step 3: Run tests**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 4: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero errors.

**Step 5: Commit**

```bash
git add extensions/openspace-core/src/node/hub.ts \
        extensions/openspace-core/src/node/__tests__/hub-mcp.spec.ts
git commit -m "fix(config): read Hub allowed origins from OPENSPACE_HUB_ORIGINS env var (T3-8)"
```

---

## Task 7: Replace `confirm()` with `MessageService` in chat widget (T3-10)

**Files:**
- Modify: `extensions/openspace-chat/src/browser/chat-widget.tsx` (around line 407)

**Context:** `window.confirm()` blocks the browser's UI thread and uses the native OS dialog (which is unstyled). `MessageService` is already injected into `OpenSpaceChatWidget` (line 48â€“49 of `chat-widget.tsx`). However `MessageService.info()` is fire-and-forget for notifications â€” for a confirm dialog, use `MessageService.warn()` with action buttons, which returns a `Promise<string | undefined>` where the resolved value is the label of the button clicked.

The `handleDeleteSession` function currently looks like:
```typescript
const confirmed = confirm(`Delete session "${activeSession.title}"?`);
if (!confirmed) return;
```

The fix makes it async:
```typescript
const action = await props.messageService.warn(
    `Delete session "${activeSession.title}"?`,
    'Delete', 'Cancel'
);
if (action !== 'Delete') return;
```

**Important:** `props.messageService` must be threaded from the `OpenSpaceChatWidget` class down to the React component. Read the file to understand the props interface (around line 117 `messageService: MessageService`).

**Step 1: Write a unit test**

In `extensions/openspace-chat/src/browser/__tests__/chat-widget.spec.ts`, read the file, then add:

```typescript
it('should use messageService.warn for delete session confirmation, not window.confirm', () => {
    const src = require('fs').readFileSync(
        require('path').join(path.dirname(new URL(import.meta.url).pathname), '../chat-widget.tsx'),
        'utf-8'
    );
    // Must NOT use window.confirm
    expect(src).not.to.include('window.confirm');
    expect(src).not.to.match(/\bconfirm\s*\(/);
    // Must use messageService.warn
    expect(src).to.include('messageService.warn');
});
```

Run: `yarn test:unit 2>&1 | tail -5` â€” Expected: FAIL.

**Step 2: Read the chat widget props structure**

Read `extensions/openspace-chat/src/browser/chat-widget.tsx` lines 110â€“135 to see the `ChatWidgetProps` interface and confirm `messageService: MessageService` is in props.

**Step 3: Apply the fix**

Find the `handleDeleteSession` function in `chat-widget.tsx`. It currently uses `confirm()`. The function is a React callback â€” make it async:

```typescript
// Before:
const handleDeleteSession = (sessionId: string) => {
    const activeSession = sessions.find(s => s.id === sessionId);
    if (!activeSession) return;
    const confirmed = confirm(`Delete session "${activeSession.title}"?`);
    if (!confirmed) return;
    props.onDeleteSession(sessionId);
};

// After:
const handleDeleteSession = async (sessionId: string) => {
    const activeSession = sessions.find(s => s.id === sessionId);
    if (!activeSession) return;
    const action = await props.messageService.warn(
        `Delete session "${activeSession.title}"?`,
        'Delete', 'Cancel'
    );
    if (action !== 'Delete') return;
    props.onDeleteSession(sessionId);
};
```

**Step 4: Run tests**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 5: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero TypeScript errors.

**Step 6: Commit**

```bash
git add extensions/openspace-chat/src/browser/chat-widget.tsx \
        extensions/openspace-chat/src/browser/__tests__/chat-widget.spec.ts
git commit -m "fix(ux): replace window.confirm with MessageService.warn for delete session dialog (T3-10)"
```

---

## Task 8: Model ID parsing fix for multi-slash IDs (T3-12)

**Files:**
- Modify: `extensions/openspace-chat/src/browser/model-selector.tsx` (line 203)
- Modify: `extensions/openspace-chat/src/browser/chat-widget.tsx` (line 431)

**Context:** Model IDs follow the format `provider/model-name` (e.g., `anthropic/claude-3-5-haiku-20241022`). But some IDs could be `anthropic/claude-3-5-sonnet/some-variant`. The current code does `split('/')` and takes index `[0]` and `[1]`, which drops everything after the second `/`. The fix: take `[0]` for provider and `slice(1).join('/')` for the model name.

**Step 1: Write a unit test**

Add to an appropriate spec file (create `extensions/openspace-chat/src/browser/__tests__/model-selector.spec.ts` if it doesn't exist, or add to `chat-widget.spec.ts`):

```typescript
it('should parse multi-slash model IDs correctly', () => {
    const src = require('fs').readFileSync(
        require('path').join(path.dirname(new URL(import.meta.url).pathname), '../model-selector.tsx'),
        'utf-8'
    );
    // Must NOT use destructuring that drops extra slashes
    expect(src).not.to.match(/const\s*\[providerId,\s*modelId\]\s*=.*split\('\/'\)/);
    // Must use slice(1).join
    expect(src).to.include("slice(1).join('/')");
});
```

Run: `yarn test:unit 2>&1 | tail -5` â€” Expected: FAIL.

**Step 2: Fix `model-selector.tsx:203`**

Find:
```typescript
const [providerId, modelId] = activeModel.split('/');
```
Replace with:
```typescript
const [providerId, ...modelParts] = activeModel.split('/');
const modelId = modelParts.join('/');
```

**Step 3: Fix `chat-widget.tsx` (line ~431)**

Read `chat-widget.tsx` around line 431. Find:
```typescript
const parts = activeModel.split('/');
```
Confirm the code uses `parts[0]` and `parts[1]`. Replace with the same pattern:
```typescript
const [providerPart, ...modelParts] = activeModel.split('/');
const modelPart = modelParts.join('/');
```
And update all downstream uses of `parts[0]` â†’ `providerPart`, `parts[1]` â†’ `modelPart`.

**Step 4: Run tests**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 5: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero TypeScript errors.

**Step 6: Commit**

```bash
git add extensions/openspace-chat/src/browser/model-selector.tsx \
        extensions/openspace-chat/src/browser/chat-widget.tsx \
        extensions/openspace-chat/src/browser/__tests__/chat-widget.spec.ts
git commit -m "fix(parsing): handle multi-slash model IDs in model selector (T3-12)"
```

---

## Task 9: Full ILogger migration â€” core browser classes (T3-14, Part 1)

**Files:**
- Modify: `extensions/openspace-core/src/browser/session-service.ts` (44 console calls)
- Modify: `extensions/openspace-core/src/browser/opencode-sync-service.ts` (17 console calls)
- Update tests: `extensions/openspace-core/src/browser/__tests__/session-service.spec.ts`
- Update tests: `extensions/openspace-core/src/browser/__tests__/opencode-sync-service.spec.ts`
- Update tests: `extensions/openspace-core/src/browser/__tests__/opencode-sync-service-validation.spec.ts`

**Context:** `ILogger` from `@theia/core/lib/common/logger` is already used in `hub.ts` and `opencode-proxy.ts`. In browser classes it must be injected via `@inject(ILogger)`. The browser ILogger writes to the Theia backend log (not `console`), which is correct behavior.

Mapping: `console.log` â†’ `this.logger.info`, `console.warn` â†’ `this.logger.warn`, `console.error` â†’ `this.logger.error`, `console.info` â†’ `this.logger.info`

**Step 1: Add ILogger to `session-service.ts`**

Add import at top (after existing imports):
```typescript
import { ILogger } from '@theia/core/lib/common/logger';
```

Add `@inject` field after the existing `@inject(OpenCodeService)` field:
```typescript
@inject(ILogger)
protected readonly logger!: ILogger;
```

Replace all 44 `console.*` calls â€” use your editor's find-replace for:
- `console.log(` â†’ `this.logger.info(`
- `console.warn(` â†’ `this.logger.warn(`
- `console.error(` â†’ `this.logger.error(`
- `console.info(` â†’ `this.logger.info(`

Run `yarn build 2>&1 | tail -5` to check for TypeScript errors as you go.

**Step 2: Update `session-service.spec.ts` mock**

Find where `SessionServiceImpl` is constructed in the test. The test injects a mock `openCodeService`. Now it also needs a mock `logger`. Find the mock construction pattern and add:
```typescript
logger: {
    info: sinon.stub(),
    warn: sinon.stub(),
    error: sinon.stub(),
    debug: sinon.stub(),
}
```

**Step 3: Add ILogger to `opencode-sync-service.ts`**

Same process: add import, add `@inject(ILogger)` field, replace all 17 `console.*` calls.

**Step 4: Update sync service test mocks**

In `opencode-sync-service.spec.ts` and `opencode-sync-service-validation.spec.ts`, add `logger` to the mock objects as in Step 2.

**Step 5: Run tests**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 6: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero errors.

**Step 7: Commit**

```bash
git add extensions/openspace-core/src/browser/session-service.ts \
        extensions/openspace-core/src/browser/opencode-sync-service.ts \
        extensions/openspace-core/src/browser/__tests__/session-service.spec.ts \
        extensions/openspace-core/src/browser/__tests__/opencode-sync-service.spec.ts \
        extensions/openspace-core/src/browser/__tests__/opencode-sync-service-validation.spec.ts
git commit -m "refactor(logging): migrate session-service and sync-service from console.* to ILogger (T3-14)"
```

---

## Task 10: Full ILogger migration â€” command contribution classes (T3-14, Part 2)

**Files:**
- Modify: `extensions/openspace-core/src/browser/editor-command-contribution.ts` (17 console calls)
- Modify: `extensions/openspace-core/src/browser/file-command-contribution.ts` (16 console calls)
- Modify: `extensions/openspace-core/src/browser/terminal-command-contribution.ts` (12 console calls)
- Modify: `extensions/openspace-core/src/browser/pane-service.ts` (15 console calls)
- Update tests: `extensions/openspace-core/src/browser/__tests__/editor-command-contribution.spec.ts`
- Update tests: `extensions/openspace-core/src/browser/__tests__/file-command-contribution.spec.ts`
- Update tests: `extensions/openspace-core/src/browser/__tests__/terminal-command-contribution.spec.ts`
- Update tests: `extensions/openspace-core/src/browser/__tests__/pane-service.spec.ts`

**Context:** Same ILogger pattern as Task 9. Each class uses `@inject` decorators on property fields. No constructor injection â€” Theia uses property injection throughout.

**Step 1: For each source file**

Add to imports:
```typescript
import { ILogger } from '@theia/core/lib/common/logger';
```

Add field (after existing `@inject` fields, before non-inject fields):
```typescript
@inject(ILogger)
protected readonly logger!: ILogger;
```

Replace `console.*` â†’ `this.logger.*` as in Task 9.

Build check after each file: `yarn build 2>&1 | tail -5`

**Step 2: Update each test mock**

In each corresponding spec file, find the mock for the contribution class. The mock is typically a plain object with stub fields. Add `logger` stub:
```typescript
logger: {
    info: sinon.stub(),
    warn: sinon.stub(),
    error: sinon.stub(),
    debug: sinon.stub(),
}
```

**Step 3: Run tests**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 4: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero errors.

**Step 5: Commit**

```bash
git add extensions/openspace-core/src/browser/editor-command-contribution.ts \
        extensions/openspace-core/src/browser/file-command-contribution.ts \
        extensions/openspace-core/src/browser/terminal-command-contribution.ts \
        extensions/openspace-core/src/browser/pane-service.ts \
        extensions/openspace-core/src/browser/__tests__/editor-command-contribution.spec.ts \
        extensions/openspace-core/src/browser/__tests__/file-command-contribution.spec.ts \
        extensions/openspace-core/src/browser/__tests__/terminal-command-contribution.spec.ts \
        extensions/openspace-core/src/browser/__tests__/pane-service.spec.ts
git commit -m "refactor(logging): migrate command contributions and pane-service from console.* to ILogger (T3-14)"
```

---

## Task 11: Full ILogger migration â€” remaining browser classes (T3-14, Part 3)

**Files:**
- Modify: `extensions/openspace-core/src/browser/bridge-contribution.ts` (8 console calls)
- Modify: `extensions/openspace-core/src/browser/permission-dialog-manager.ts` (3 console calls)
- Modify: `extensions/openspace-chat/src/browser/chat-widget.tsx` (8 console calls)
- Modify: `extensions/openspace-whiteboard/src/browser/whiteboard-command-contribution.ts` (11 console calls)
- Modify: `extensions/openspace-whiteboard/src/browser/whiteboard-widget.tsx` (6 console calls)
- Modify: `extensions/openspace-whiteboard/src/browser/whiteboard-service.ts` (5 console calls)
- Modify: `extensions/openspace-whiteboard/src/browser/whiteboard-open-handler.ts` (1 console call)
- Modify: `extensions/openspace-presentation/src/browser/presentation-command-contribution.ts` (9 console calls)
- Modify: `extensions/openspace-presentation/src/browser/presentation-widget.tsx` (4 console calls)
- Modify: `extensions/openspace-presentation/src/browser/presentation-service.ts` (3 console calls)
- Modify: `extensions/openspace-presentation/src/browser/presentation-open-handler.ts` (1 console call)
- Modify small module files (1 console call each): `openspace-whiteboard-frontend-module.ts`, `openspace-settings-frontend-module.ts`, `openspace-presentation-frontend-module.ts`

**Context:** For `chat-widget.tsx`: the `OpenSpaceChatWidget` class already has `@inject(MessageService)` â€” add `@inject(ILogger)` similarly. For React function components in `whiteboard-widget.tsx` and `presentation-widget.tsx`: these are rendered by an `@injectable()` class â€” the logger must be held on the class and passed via props or used before React rendering. The cleanest approach: keep one `console.*` call in the React component if it's truly in a render path with no class reference; migrate everything in the class body.

**Important for module files** (e.g., `openspace-whiteboard-frontend-module.ts`): these have module-level `console.log` calls outside a class. Replace with a comment or `// eslint-disable-next-line no-console` line since there's no class to inject into. Better: remove debug logging that shouldn't be in production modules at all.

**Step 1: For each `@injectable()` class file**

Add ILogger import and `@inject(ILogger)` field, replace `console.*` calls.

**Step 2: For module files with 1 console call**

Read each file. If the console call is a debug/startup log (e.g., "Whiteboard module loaded"), remove it entirely or replace with a comment. These don't belong in production bundles.

**Step 3: For React function components** (`whiteboard-widget.tsx`, `presentation-widget.tsx`)

These files have a mix of class code (the `@injectable()` widget class) and React function components. Only migrate `console.*` calls in the class body. For any `console.*` inside a `React.useEffect` or event handler inside a function component, wrap with `process.env.NODE_ENV !== 'production'` guard:
```typescript
if (process.env.NODE_ENV !== 'production') {
    console.warn('[WhiteboardWidget] ...');
}
```
This is a pragmatic choice â€” React components can't easily use injected services.

**Step 4: Run tests**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 5: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero errors.

**Step 6: Commit**

```bash
git add extensions/openspace-chat/src/browser/chat-widget.tsx \
        extensions/openspace-whiteboard/src/browser/whiteboard-command-contribution.ts \
        extensions/openspace-whiteboard/src/browser/whiteboard-widget.tsx \
        extensions/openspace-whiteboard/src/browser/whiteboard-service.ts \
        extensions/openspace-whiteboard/src/browser/whiteboard-open-handler.ts \
        extensions/openspace-whiteboard/src/browser/openspace-whiteboard-frontend-module.ts \
        extensions/openspace-presentation/src/browser/presentation-command-contribution.ts \
        extensions/openspace-presentation/src/browser/presentation-widget.tsx \
        extensions/openspace-presentation/src/browser/presentation-service.ts \
        extensions/openspace-presentation/src/browser/presentation-open-handler.ts \
        extensions/openspace-presentation/src/browser/openspace-presentation-frontend-module.ts \
        extensions/openspace-core/src/browser/bridge-contribution.ts \
        extensions/openspace-core/src/browser/permission-dialog-manager.ts \
        extensions/openspace-settings/src/browser/openspace-settings-frontend-module.ts
git commit -m "refactor(logging): migrate remaining browser classes from console.* to ILogger (T3-14)"
```

---

## Task 12: Remove unused devDependencies (T3-15)

**Files:**
- Modify: `package.json` (root) and/or extension `package.json` files

**Context:** `depcheck` is not installed â€” use `npx depcheck` (runs without prior install). Run it against the root workspace and each extension. Confirm before removing any package that it's not used via dynamic require or an implicit peer.

**Step 1: Run depcheck**

```bash
npx --yes depcheck . 2>&1 | head -50
```

Read the "Unused devDependencies" section. Note: `depcheck` has false positives for packages used via CLI (e.g., `mocha`, `ts-node`) â€” cross-check before removing.

**Step 2: For each reported unused devDependency**

Search the codebase to confirm it's genuinely unused:
```bash
grep -r "package-name" . --include="*.ts" --include="*.tsx" --include="*.json" | grep -v "node_modules\|package-lock"
```

Only remove packages with zero confirmed references.

**Step 3: Run tests after each removal**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: still passing.

**Step 4: Commit**

```bash
git add package.json
git commit -m "chore: remove unused devDependencies (T3-15)"
```

---

## Task 13: Security validation checklist (1C.7)

**Files:** None modified â€” this is a verification pass.

**Context:** Run through the 10-item security checklist. Some items are code checks (read the source), some are functional checks (run the tests). Document results.

**Step 1: Command input validation**

```bash
grep -n "validateAgentCommand\|validatePath\|isPathSafe\|SENSITIVE_FILES" \
    extensions/openspace-core/src/browser/opencode-sync-service.ts \
    extensions/openspace-core/src/browser/editor-command-contribution.ts \
    extensions/openspace-core/src/browser/file-command-contribution.ts
```
Expected: validation present in all three contributions.

**Step 2: Symlink resolution**

```bash
grep -n "validatePath\|realpath" extensions/openspace-core/src/node/opencode-proxy.ts
```
Expected: `validatePath` method present with `fs.promises.realpath` call.

**Step 3: Sensitive file denylist**

```bash
grep -n "SENSITIVE_FILES\|sensitiveFiles\|id_rsa\|\.env" extensions/openspace-core/src/common/sensitive-files.ts
```
Expected: patterns present. Count should be 19+.

**Step 4: Permission dialog focus trap + deny**

```bash
grep -n "focusableElements\|Tab.*cycling\|preventDefault.*Tab" extensions/openspace-core/src/browser/permission-dialog.tsx
```
Expected: Tab focus trap code present.

```bash
grep -n "Deny\|deny\|onDeny" extensions/openspace-core/src/browser/permission-dialog.tsx | head -5
```
Expected: explicit deny button present.

**Step 5: XSS (presentation markdown)**

```bash
grep -rn "DOMPurify\|sanitize\|innerHTML" extensions/openspace-presentation/src/browser/ | head -10
```
Expected: sanitization present, or no `innerHTML` usage.

**Step 6: postMessage origin validation (whiteboard)**

```bash
grep -n "event.origin\|postMessage.*origin\|allowedOrigins" extensions/openspace-whiteboard/src/browser/whiteboard-widget.tsx
```
Expected: origin check present.

**Step 7: Hub allowed origins**

```bash
grep -n "OPENSPACE_HUB_ORIGINS\|validateOrigin" extensions/openspace-core/src/node/hub.ts
```
Expected: `validateOrigin` method and env var read present (added in Task 6).

**Step 8: File size limits**

```bash
grep -n "10.*MB\|10485760\|maxSize\|fileSizeLimit\|byteLength\|readFile" extensions/openspace-core/src/node/opencode-proxy.ts | head -10
```
Expected: size limit check present.

**Step 9: Dangerous command confirmation**

```bash
grep -n "dangerousCommand\|dangerous.*pattern\|requiresConfirmation\|rm.*-rf\|sudo" \
    extensions/openspace-core/src/browser/terminal-command-contribution.ts | head -10
```
Expected: dangerous command patterns checked.

**Step 10: No test hooks in production**

```bash
grep -n "__openspace_test__\|NODE_ENV" extensions/openspace-core/src/browser/opencode-sync-service.ts | head -5
```
Expected: `NODE_ENV !== 'production'` guard wrapping the test hook block.

**Step 11: Full test suite**

```bash
yarn test:unit 2>&1 | tail -5
```
Expected: 454+ passing, 0 failing.

**Step 12: Build check**

```bash
yarn build 2>&1 | tail -5
```
Expected: zero TypeScript errors.

**Step 13: Update WORKPLAN.md**

Mark 1C.5, 1C.6, 1C.7 as âœ…. Update the Overall Progress table Phase 1C row from `ðŸŸ¡ In progress` to `âœ… COMPLETE`. Update Next Task to Phase 4-Val.

```bash
git add docs/architecture/WORKPLAN.md
git commit -m "docs: mark Phase 1C complete in WORKPLAN"
```

---

## Verification Checklist (after all 13 tasks)

```bash
yarn test:unit 2>&1 | tail -5   # Must show: 454+ passing, 0 failing
yarn build 2>&1 | tail -5       # Must show: zero TypeScript errors
```

Security items:
- [ ] T3-6: UUID for message IDs â€” no `Date.now()` for part IDs
- [ ] T3-8: Hub origins from env var â€” `OPENSPACE_HUB_ORIGINS` supported
- [ ] T3-10: `confirm()` replaced by `MessageService.warn()`
- [ ] T3-12: Multi-slash model ID parsing fixed
- [ ] T3-14: All `console.*` migrated to `ILogger` in `@injectable()` classes
- [ ] T3-15: Unused devDeps removed
- [ ] T2-27: All `waitForTimeout` replaced in E2E tests
- [ ] T2-28: Route mock ordering fixed in session-management.spec.ts
- [ ] 1C.7 security checklist: all 10 items verified
- [ ] `yarn test:unit` passes (454+ tests)
- [ ] `yarn build` clean
